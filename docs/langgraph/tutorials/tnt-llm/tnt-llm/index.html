
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Build language agents as graphs">
      
      
      
        <link rel="canonical" href="https://langchain-ai.github.io/langgraph/tutorials/tnt-llm/tnt-llm/">
      
      
        <link rel="prev" href="../../storm/storm/">
      
      
        <link rel="next" href="../../web-navigation/web_voyager/">
      
      
        
      
      
      <link rel="icon" href="../../../static/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44+insiders-4.53.14">
    
    
  
    <title>TNT-LLM: Text Mining at Scale</title>
  

    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.12320a83.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Public+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Public Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-G8X6ELZYE0"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-G8X6ELZYE0",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-G8X6ELZYE0",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Public+Sans&display=swap");
    :root {
      --md-primary-fg-color: #333333;
      --md-accent-fg-color: #1E88E5;
      --md-default-bg-color: #FFFFFF;
      --md-default-fg-color: #333333;
      --md-text-font-family: "Public Sans", sans-serif;
    }

    body {
      font-family: var(--md-text-font-family);
      background-color: var(--md-default-bg-color);
      color: var(--md-default-fg-color);
    }

    .md-main {
      background-color: #FFFFFF;
    }

    .md-footer {
      background-color: #F5F5F5;
      color: #666666;
    }

    .md-footer-meta {
      background-color: #EEEEEE;
    }

    .md-typeset a {
      color: #1E88E5;
    }

    .md-typeset a:hover {
      color: #1565C0;
    }

    .md-nav__link--active,
    .md-nav__link:active {
      color: #1E88E5;
    }

    .md-search__input {
      background-color: #F5F5F5;
      color: #333333;
    }

    .md-search__input:hover,
    .md-search__input:focus {
      background-color: #EEEEEE;
    }
    /* Table of contents styles */
    .md-nav--secondary .md-nav__item--active > .md-nav__link {
      font-weight: bold;
      color: var(--md-primary-fg-color);
    }

    .md-nav--secondary .md-nav__item--nested > .md-nav__link {
      font-weight: normal;
      color: var(--md-default-fg-color);
    }

    .md-nav--secondary .md-nav__item--nested > .md-nav__link::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 6px;
      background-color: var(--md-default-fg-color);
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    [data-md-color-scheme="slate"] {
      --md-default-bg-color: #1E1E1E;
      --md-default-fg-color: #FFFFFF;
      --md-accent-fg-color: #64B5F6;
    }

    [data-md-color-scheme="slate"] .md-main {
      background-color: #1E1E1E;
    }

    [data-md-color-scheme="slate"] .navbar {
      background-color: #1E1E1E;
      color: #FFFFFF;
      box-shadow: none;
    }

    [data-md-color-scheme="slate"] .md-footer {
      background-color: #1E1E1E;
      color: #BDBDBD;
    }

    [data-md-color-scheme="slate"] .md-header {
      background-color: #1E1E1E;
      color: #BDBDBD;
    }

    [data-md-color-scheme="slate"] .md-tabs {
      background-color: #1E1E1E;
      color: #BDBDBD;
    }

    [data-md-color-scheme="slate"] .md-search__input {
      background-color: #F5F5F5;
      color: #333333;
    }

    [data-md-color-scheme="slate"] .md-search__icon {
      color: #333333;
    }

    [data-md-color-scheme="slate"] .md-search__input::placeholder {
      color: #333333;
    }

    [data-md-color-scheme="slate"] .md-footer-meta {
      background-color: #1E1E1E;
    }

    [data-md-color-scheme="slate"] .md-typeset a {
      color: #64B5F6;
    }

    [data-md-color-scheme="slate"] .md-typeset a:hover {
      color: #90CAF9;
    }

    .notebook-links {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }
    .notebook-links .md-content__button {
      margin-left: 0.5rem;
    }

    [data-md-color-scheme=default] .logo-dark {
      display: none !important;
    }

    [data-md-color-scheme=slate] .logo-light {
      display: none !important;
    }

    .jupyter-wrapper .jp-CodeCell .jp-Cell-inputWrapper .jp-InputPrompt.jp-InputArea-prompt {
      display: none !important;
    }

    .jupyter-wrapper .jp-Notebook .jp-Cell .jp-OutputPrompt {
      display: none !important;
    }

    .md-banner {
      background-color: #CFC9FA;
      color: #000000;
    }

    .md-banner a {
      color: #000000;
      text-decoration: underline;
    }

    .md-banner a:hover {
      color: #000000;
    }

    /* Dark mode banner links */
    [data-md-color-scheme="slate"] .md-banner a {
      color: #000000;
    }

    [data-md-color-scheme="slate"] .md-banner a:hover {
      color: #000000;
    }

    /* control the navbar depth */
    [data-md-level="2"] .md-nav {
      display: none;
    }

    /* disable the collapse/expand icon in the navar */
    .md-nav__icon {
      display: none;
    }
  </style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="gray">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tnt-llm-text-mining-at-scale" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            
            
  <b>Join us at <a href="https://interrupt.langchain.com/" target="_blank" rel="noopener noreferrer"> Interrupt: The Agent AI Conference by LangChain</a> on May 13 & 14 in San Francisco!</b>

          </div>
          
            <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="" class="md-header__button md-logo" aria-label="" data-md-component="logo">
      
  <img src="../../../static/wordmark_dark.svg" alt="logo" class="logo-light" />
  <img src="../../../static/wordmark_light.svg" alt="logo" class="logo-dark" />

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              TNT-LLM: Text Mining at Scale
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="gray"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="white"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/langchain-ai/langgraph" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../.." class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../reference/graphs/" class="md-tabs__link">
          
  
    
  
  API reference

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="" class="md-nav__button md-logo" aria-label="" data-md-component="logo">
      
  <img src="../../../static/wordmark_dark.svg" alt="logo" class="logo-light" />
  <img src="../../../static/wordmark_light.svg" alt="logo" class="logo-dark" />

    </a>
    
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/langchain-ai/langgraph" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Home
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Get started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Get started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Learn the basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../deployment/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" checked>
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../how-tos/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    How-to Guides
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../concepts/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1_3_3" id="__nav_1_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#quick-start" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#chatbots" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Chatbots
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#rag" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    RAG
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#agent-architectures" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Agent Architectures
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#evaluation" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Evaluation & Analysis
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_3_7" checked>
        
          
          <label class="md-nav__link" for="__nav_1_3_3_7" id="__nav_1_3_3_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Experimental
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_1_3_3_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Experimental
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials#experimental" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Experimental
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../storm/storm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Web Research (STORM)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    TNT-LLM: Text Mining at Scale
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    TNT-LLM: Text Mining at Scale
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Define the graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Define the graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graph-state" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graph State
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Define nodes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Define nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-summarize-docs" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Summarize Docs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-split-into-minibatches" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Split into Minibatches
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3a-taxonomy-generation-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.a Taxonomy Generation Utilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-generate-initial-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Generate initial taxonomy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-update-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Update Taxonomy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-review-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Review Taxonomy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compile-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compile the Graph
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Use the graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Use the graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#invoke" class="md-nav__link">
    <span class="md-ellipsis">
      
        Invoke
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-result" class="md-nav__link">
    <span class="md-ellipsis">
      
        Final Result
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Final Taxonomy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-2-labeling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Labeling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 2: Labeling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#label-training-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Label Training Data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#train-classifier" class="md-nav__link">
    <span class="md-ellipsis">
      
        Train Classifier
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-3-deploy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 3: Deploy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 3: Deploy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#to-deploy" class="md-nav__link">
    <span class="md-ellipsis">
      
        To deploy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example:
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../web-navigation/web_voyager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Web Voyager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usaco/usaco/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Competitive Programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../extraction/retries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Complex data extraction with function calling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../concepts#langgraph-platform" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    LangGraph Platform
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Resources
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Resources
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../prebuilt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Prebuilt Agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adopters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Companies using LangGraph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../troubleshooting/errors/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://academy.langchain.com/courses/intro-to-langgraph" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    LangGraph Academy Course
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../reference/graphs/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    API reference
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Define the graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Define the graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graph-state" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graph State
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Define nodes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Define nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-summarize-docs" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Summarize Docs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-split-into-minibatches" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Split into Minibatches
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3a-taxonomy-generation-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.a Taxonomy Generation Utilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-generate-initial-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Generate initial taxonomy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-update-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Update Taxonomy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-review-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Review Taxonomy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compile-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compile the Graph
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Use the graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Use the graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#invoke" class="md-nav__link">
    <span class="md-ellipsis">
      
        Invoke
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-result" class="md-nav__link">
    <span class="md-ellipsis">
      
        Final Result
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Final Taxonomy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-2-labeling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Labeling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 2: Labeling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#label-training-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Label Training Data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#train-classifier" class="md-nav__link">
    <span class="md-ellipsis">
      
        Train Classifier
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-3-deploy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 3: Deploy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 3: Deploy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#to-deploy" class="md-nav__link">
    <span class="md-ellipsis">
      
        To deploy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example:
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
      
        
  
    
    
      <li class="md-path__item">
        <a href="../../.." class="md-path__link">
          
  <span class="md-ellipsis">
    Home
  </span>

        </a>
      </li>
    
  

      
        
  
    
    
      
  
    
    
      <li class="md-path__item">
        <a href="../../../how-tos/" class="md-path__link">
          
  <span class="md-ellipsis">
    Guides
  </span>

        </a>
      </li>
    
  

    
  

      
        
  
    
    
      <li class="md-path__item">
        <a href="../../" class="md-path__link">
          
  <span class="md-ellipsis">
    Tutorials
  </span>

        </a>
      </li>
    
  

      
        
  
    
    
      <li class="md-path__item">
        <a href="../../../tutorials#experimental" class="md-path__link">
          
  <span class="md-ellipsis">
    Experimental
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
<div class="notebook-links">
  
</div>


                  


  
    <a href="https://github.com/langchain-ai/langgraph/edit/main/docs/docs/tutorials/tnt-llm/tnt-llm.ipynb" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="tnt-llm-text-mining-at-scale">TNT-LLM: Text Mining at Scale<a class="headerlink" href="#tnt-llm-text-mining-at-scale" title="Permanent link">&para;</a></h1>
<p><a href="https://arxiv.org/abs/2403.12173">TNT-LLM</a> by Wan, et. al describes a taxonomy generation and classification system developed by Microsoft for their Bing Copilot application.</p>
<p>It generates a rich, interpretable taxonomy of user intents (or other categories) from raw conversation logs. This taxonomy can then be used downstream by LLMs to label logs, which in turn can be used as training data to adapt a cheap classifier (such as logistic regression classifier on embeddings) that can be deployed in your app.</p>
<p>TNT-LLM has three main phases:</p>
<ol>
<li>Generate Taxonomy</li>
<li>Label Training Data</li>
<li>Finetune classifier + deploy</li>
</ol>
<p>When applying LangGraph in this notebook, we will focus on the first phase: taxonomy generation (blue in the diagram below). We then show how to label and fit the classifier in subsequent steps below.</p>
<p><img src="../img/tnt_llm.png" src="../img/tnt_llm.png"></p>
<p>To generate the taxonomy, TNT-LLM proposes 5 steps:</p>
<ol>
<li><strong>Summarize</strong> chat logs using a lower-cost LLM (batched over all logs in the sample)</li>
<li><strong>Batch</strong> the logs into random minibatches</li>
<li><strong>Generate</strong> an initial taxonomy from the first minibatch</li>
<li><strong>Update</strong> the taxonomy on each subsequent minibatch via a ritique and revise prompt</li>
<li><strong>Review</strong> the final taxonomy, scoring its quality and generating a final value using a final sample.</li>
</ol>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>First, let's install our required packages and set our API keys</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="o">%%</span><span class="n">capture</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">langgraph</span> <span class="n">langchain_anthropic</span> <span class="n">langsmith</span> <span class="n">langchain</span><span class="o">-</span><span class="n">community</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">sklearn</span> <span class="n">langchain_openai</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>        <span class="k">return</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="admonition tip">
    <p class="admonition-title">Set up <a href="https://smith.langchain.com">LangSmith</a> for LangGraph development</p>
    <p style="padding-top: 5px;">
        Sign up for LangSmith to quickly spot issues and improve the performance of your LangGraph projects. LangSmith lets you use trace data to debug, test, and monitor your LLM apps built with LangGraph — read more about how to get started <a href="https://docs.smith.langchain.com">here</a>. 
    </p>
</div>

<h2 id="define-the-graph">Define the graph<a class="headerlink" href="#define-the-graph" title="Permanent link">&para;</a></h2>
<h3 id="graph-state">Graph State<a class="headerlink" href="#graph-state" title="Permanent link">&para;</a></h3>
<p>Since each node of a StateGraph accepts the state (and returns an updated state), we'll define that at the outset.</p>
<p>Our flow takes in a list of documents, batches them, and then generates and refines candidate taxonomies as interpretable "clusters".</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;tnt-llm&quot;</span><span class="p">)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">Doc</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="n">explanation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="k">class</span><span class="w"> </span><span class="nc">TaxonomyGenerationState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="c1"># The raw docs; we inject summaries within them in the first step</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>    <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Doc</span><span class="p">]</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="c1"># Indices to be concise</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="n">minibatches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>    <span class="c1"># Candidate Taxonomies (full trajectory)</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="n">clusters</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]],</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>
</span></code></pre></div>
<h3 id="define-nodes">Define nodes<a class="headerlink" href="#define-nodes" title="Permanent link">&para;</a></h3>
<h4 id="1-summarize-docs">1. Summarize Docs<a class="headerlink" href="#1-summarize-docs" title="Permanent link">&para;</a></h4>
<p>Chat logs can get quite long. Our taxonomy generation step needs to see large, diverse minibatches to be able to adequately capture the distribution of categories. To ensure they can all fit efficiently into the context window, we first summarize each chat log. Downstream steps will use these summaries instead of the raw doc content.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain</span><span class="w"> </span><span class="kn">import</span> <span class="n">hub</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.output_parsers</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrOutputParser</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables</span><span class="w"> </span><span class="kn">import</span> <span class="n">RunnableConfig</span><span class="p">,</span> <span class="n">RunnableLambda</span><span class="p">,</span> <span class="n">RunnablePassthrough</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="n">summary_prompt</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s2">&quot;wfh/tnt-llm-summary-generation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="n">summary_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">explanation_length</span><span class="o">=</span><span class="mi">30</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="p">)</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_summary</span><span class="p">(</span><span class="n">xml_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="n">summary_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;summary&gt;(.*?)&lt;/summary&gt;&quot;</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    <span class="n">explanation_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;explanation&gt;(.*?)&lt;/explanation&gt;&quot;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="n">summary_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">summary_pattern</span><span class="p">,</span> <span class="n">xml_string</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="n">explanation_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">explanation_pattern</span><span class="p">,</span> <span class="n">xml_string</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="n">summary_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">summary_match</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="n">explanation</span> <span class="o">=</span> <span class="n">explanation_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">explanation_match</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span> <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="n">explanation</span><span class="p">}</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="n">summary_llm_chain</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>    <span class="n">summary_prompt</span> <span class="o">|</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-haiku-20240307&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>    <span class="c1"># Customize the tracing name for easier organization</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;GenerateSummary&quot;</span><span class="p">)</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="n">summary_chain</span> <span class="o">=</span> <span class="n">summary_llm_chain</span> <span class="o">|</span> <span class="n">parse_summary</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="c1"># Now combine as a &quot;map&quot; operation in a map-reduce chain</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="c1"># Input: state</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="c1"># Output: state U summaries</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="c1"># Processes docs in parallel</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_content</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">TaxonomyGenerationState</span><span class="p">):</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>    <span class="n">docs</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="n">map_step</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>    <span class="n">summaries</span><span class="o">=</span><span class="n">get_content</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>    <span class="c1"># This effectively creates a &quot;map&quot; operation</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>    <span class="c1"># Note you can make this more robust by handling individual errors</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>    <span class="o">|</span> <span class="n">RunnableLambda</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">summary_chain</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">afunc</span><span class="o">=</span><span class="n">summary_chain</span><span class="o">.</span><span class="n">abatch</span><span class="p">)</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="p">)</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a><span class="k">def</span><span class="w"> </span><span class="nf">reduce_summaries</span><span class="p">(</span><span class="n">combined</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaxonomyGenerationState</span><span class="p">:</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>    <span class="n">summaries</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;summaries&quot;</span><span class="p">]</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>    <span class="n">documents</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>        <span class="s2">&quot;documents&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>            <span class="p">{</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>                <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summ_info</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>                <span class="s2">&quot;explanation&quot;</span><span class="p">:</span> <span class="n">summ_info</span><span class="p">[</span><span class="s2">&quot;explanation&quot;</span><span class="p">],</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>            <span class="p">}</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>            <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">summ_info</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">summaries</span><span class="p">)</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>        <span class="p">]</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>    <span class="p">}</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a><span class="c1"># This is actually the node itself!</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a><span class="n">map_reduce_chain</span> <span class="o">=</span> <span class="n">map_step</span> <span class="o">|</span> <span class="n">reduce_summaries</span>
</span></code></pre></div>
<p>API Reference: <a href="https://python.langchain.com/api_reference/anthropic/chat_models/langchain_anthropic.chat_models.ChatAnthropic.html">ChatAnthropic</a> | <a href="https://python.langchain.com/api_reference/core/output_parsers/langchain_core.output_parsers.string.StrOutputParser.html">StrOutputParser</a> | <a href="https://python.langchain.com/api_reference/core/runnables/langchain_core.runnables.config.RunnableConfig.html">RunnableConfig</a> | <a href="https://python.langchain.com/api_reference/core/runnables/langchain_core.runnables.base.RunnableLambda.html">RunnableLambda</a> | <a href="https://python.langchain.com/api_reference/core/runnables/langchain_core.runnables.passthrough.RunnablePassthrough.html">RunnablePassthrough</a></p>
<h4 id="2-split-into-minibatches">2. Split into Minibatches<a class="headerlink" href="#2-split-into-minibatches" title="Permanent link">&para;</a></h4>
<p>Each minibatch contains a random sample of docs. This lets the flow identify inadequacies in the current taxonomy using new data.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_minibatches</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">TaxonomyGenerationState</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span><span class="p">):</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="p">)))</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">:</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="c1"># Don&#39;t pad needlessly if we can&#39;t fill a single batch</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">indices</span><span class="p">]</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="n">num_full_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="n">indices</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_full_batches</span><span class="p">)</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="p">]</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="n">leftovers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">%</span> <span class="n">batch_size</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="k">if</span> <span class="n">leftovers</span><span class="p">:</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="n">last_batch</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">num_full_batches</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="p">:]</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="n">elements_to_add</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">leftovers</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="n">last_batch</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">elements_to_add</span><span class="p">)</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>        <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_batch</span><span class="p">)</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="s2">&quot;minibatches&quot;</span><span class="p">:</span> <span class="n">batches</span><span class="p">,</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="p">}</span>
</span></code></pre></div>
<h4 id="3a-taxonomy-generation-utilities">3.a Taxonomy Generation Utilities<a class="headerlink" href="#3a-taxonomy-generation-utilities" title="Permanent link">&para;</a></h4>
<p>This section of the graph is a generate -&gt; update 🔄 -&gt; review cycle. Each node shares a LOT of logic, which we have factored out into the shared functions below.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runnable</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_taxa</span><span class="p">(</span><span class="n">output_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the taxonomy from the generated output.&quot;&quot;&quot;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">cluster_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="sa">r</span><span class="s2">&quot;\s*&lt;id&gt;(.*?)&lt;/id&gt;\s*&lt;name&gt;(.*?)&lt;/name&gt;\s*&lt;description&gt;(.*?)&lt;/description&gt;\s*&quot;</span><span class="p">,</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="n">output_text</span><span class="p">,</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="p">)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">cluster_matches</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="p">]</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="c1"># We don&#39;t parse the explanation since it isn&#39;t used downstream</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;clusters&quot;</span><span class="p">:</span> <span class="n">clusters</span><span class="p">}</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">format_docs</span><span class="p">(</span><span class="n">docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Doc</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="n">xml_table</span> <span class="o">=</span> <span class="s2">&quot;&lt;conversations&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="n">xml_table</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;conv_summ id=</span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&lt;/conv_summ&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    <span class="n">xml_table</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/conversations&gt;&quot;</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>    <span class="k">return</span> <span class="n">xml_table</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">format_taxonomy</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>    <span class="n">xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;cluster_table&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="n">xml</span> <span class="o">+=</span> <span class="s2">&quot;  &lt;cluster&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        <span class="n">xml</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;    &lt;id&gt;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&lt;/id&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="n">xml</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;    &lt;name&gt;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&lt;/name&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="n">xml</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;    &lt;description&gt;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&lt;/description&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>        <span class="n">xml</span> <span class="o">+=</span> <span class="s2">&quot;  &lt;/cluster&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>    <span class="n">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/cluster_table&gt;&quot;</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>    <span class="k">return</span> <span class="n">xml</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a><span class="k">def</span><span class="w"> </span><span class="nf">invoke_taxonomy_chain</span><span class="p">(</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>    <span class="n">chain</span><span class="p">:</span> <span class="n">Runnable</span><span class="p">,</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">TaxonomyGenerationState</span><span class="p">,</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span><span class="p">,</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>    <span class="n">mb_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaxonomyGenerationState</span><span class="p">:</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>    <span class="n">configurable</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>    <span class="n">docs</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>    <span class="n">minibatch</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">mb_indices</span><span class="p">]</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>    <span class="n">data_table_xml</span> <span class="o">=</span> <span class="n">format_docs</span><span class="p">(</span><span class="n">minibatch</span><span class="p">)</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>    <span class="n">previous_taxonomy</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>    <span class="n">cluster_table_xml</span> <span class="o">=</span> <span class="n">format_taxonomy</span><span class="p">(</span><span class="n">previous_taxonomy</span><span class="p">)</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>    <span class="n">updated_taxonomy</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>        <span class="p">{</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>            <span class="s2">&quot;data_xml&quot;</span><span class="p">:</span> <span class="n">data_table_xml</span><span class="p">,</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>            <span class="s2">&quot;use_case&quot;</span><span class="p">:</span> <span class="n">configurable</span><span class="p">[</span><span class="s2">&quot;use_case&quot;</span><span class="p">],</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>            <span class="s2">&quot;cluster_table_xml&quot;</span><span class="p">:</span> <span class="n">cluster_table_xml</span><span class="p">,</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>            <span class="s2">&quot;suggestion_length&quot;</span><span class="p">:</span> <span class="n">configurable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suggestion_length&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>            <span class="s2">&quot;cluster_name_length&quot;</span><span class="p">:</span> <span class="n">configurable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster_name_length&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>            <span class="s2">&quot;cluster_description_length&quot;</span><span class="p">:</span> <span class="n">configurable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>                <span class="s2">&quot;cluster_description_length&quot;</span><span class="p">,</span> <span class="mi">30</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>            <span class="p">),</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>            <span class="s2">&quot;explanation_length&quot;</span><span class="p">:</span> <span class="n">configurable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;explanation_length&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>            <span class="s2">&quot;max_num_clusters&quot;</span><span class="p">:</span> <span class="n">configurable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_num_clusters&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>        <span class="p">}</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>    <span class="p">)</span>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>        <span class="s2">&quot;clusters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">updated_taxonomy</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]],</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>    <span class="p">}</span>
</span></code></pre></div>
<p>API Reference: <a href="https://python.langchain.com/api_reference/core/runnables/langchain_core.runnables.base.Runnable.html">Runnable</a></p>
<h4 id="3-generate-initial-taxonomy">3. Generate initial taxonomy<a class="headerlink" href="#3-generate-initial-taxonomy" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># We will share an LLM for each step of the generate -&gt; update -&gt; review cycle</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c1"># You may want to consider using Opus or another more powerful model for this</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">taxonomy_generation_llm</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-haiku-20240307&quot;</span><span class="p">,</span> <span class="n">max_tokens_to_sample</span><span class="o">=</span><span class="mi">2000</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="p">)</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="c1">## Initial generation</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="n">taxonomy_generation_prompt</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s2">&quot;wfh/tnt-llm-taxonomy-generation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span class="n">use_case</span><span class="o">=</span><span class="s2">&quot;Generate the taxonomy that can be used to label the user intent in the conversation.&quot;</span><span class="p">,</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="p">)</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="n">taxa_gen_llm_chain</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="n">taxonomy_generation_prompt</span> <span class="o">|</span> <span class="n">taxonomy_generation_llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;GenerateTaxonomy&quot;</span><span class="p">)</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="n">generate_taxonomy_chain</span> <span class="o">=</span> <span class="n">taxa_gen_llm_chain</span> <span class="o">|</span> <span class="n">parse_taxa</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_taxonomy</span><span class="p">(</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">TaxonomyGenerationState</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaxonomyGenerationState</span><span class="p">:</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="k">return</span> <span class="n">invoke_taxonomy_chain</span><span class="p">(</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>        <span class="n">generate_taxonomy_chain</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;minibatches&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="p">)</span>
</span></code></pre></div>
<h4 id="4-update-taxonomy">4. Update Taxonomy<a class="headerlink" href="#4-update-taxonomy" title="Permanent link">&para;</a></h4>
<p>This is a "critique -&gt; revise" step that is repeated N times.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">taxonomy_update_prompt</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s2">&quot;wfh/tnt-llm-taxonomy-update&quot;</span><span class="p">)</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">taxa_update_llm_chain</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="n">taxonomy_update_prompt</span> <span class="o">|</span> <span class="n">taxonomy_generation_llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;UpdateTaxonomy&quot;</span><span class="p">)</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">update_taxonomy_chain</span> <span class="o">=</span> <span class="n">taxa_update_llm_chain</span> <span class="o">|</span> <span class="n">parse_taxa</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_taxonomy</span><span class="p">(</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">TaxonomyGenerationState</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaxonomyGenerationState</span><span class="p">:</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="n">which_mb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">])</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;minibatches&quot;</span><span class="p">])</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="k">return</span> <span class="n">invoke_taxonomy_chain</span><span class="p">(</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="n">update_taxonomy_chain</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;minibatches&quot;</span><span class="p">][</span><span class="n">which_mb</span><span class="p">]</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="p">)</span>
</span></code></pre></div>
<h4 id="5-review-taxonomy">5. Review Taxonomy<a class="headerlink" href="#5-review-taxonomy" title="Permanent link">&para;</a></h4>
<p>This runs once we've processed all the minibatches.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">taxonomy_review_prompt</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s2">&quot;wfh/tnt-llm-taxonomy-review&quot;</span><span class="p">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">taxa_review_llm_chain</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">taxonomy_review_prompt</span> <span class="o">|</span> <span class="n">taxonomy_generation_llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;ReviewTaxonomy&quot;</span><span class="p">)</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="n">review_taxonomy_chain</span> <span class="o">=</span> <span class="n">taxa_review_llm_chain</span> <span class="o">|</span> <span class="n">parse_taxa</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">review_taxonomy</span><span class="p">(</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">TaxonomyGenerationState</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaxonomyGenerationState</span><span class="p">:</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="p">)))</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="k">return</span> <span class="n">invoke_taxonomy_chain</span><span class="p">(</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        <span class="n">review_taxonomy_chain</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">indices</span><span class="p">[:</span><span class="n">batch_size</span><span class="p">]</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    <span class="p">)</span>
</span></code></pre></div>
<h3 id="compile-the-graph">Compile the Graph<a class="headerlink" href="#compile-the-graph" title="Permanent link">&para;</a></h3>
<p>With all the functionality defined, we can build the graph!</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">graph</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">TaxonomyGenerationState</span><span class="p">)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;summarize&quot;</span><span class="p">,</span> <span class="n">map_reduce_chain</span><span class="p">)</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;get_minibatches&quot;</span><span class="p">,</span> <span class="n">get_minibatches</span><span class="p">)</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;generate_taxonomy&quot;</span><span class="p">,</span> <span class="n">generate_taxonomy</span><span class="p">)</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;update_taxonomy&quot;</span><span class="p">,</span> <span class="n">update_taxonomy</span><span class="p">)</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;review_taxonomy&quot;</span><span class="p">,</span> <span class="n">review_taxonomy</span><span class="p">)</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;summarize&quot;</span><span class="p">,</span> <span class="s2">&quot;get_minibatches&quot;</span><span class="p">)</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;get_minibatches&quot;</span><span class="p">,</span> <span class="s2">&quot;generate_taxonomy&quot;</span><span class="p">)</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;generate_taxonomy&quot;</span><span class="p">,</span> <span class="s2">&quot;update_taxonomy&quot;</span><span class="p">)</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">should_review</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">TaxonomyGenerationState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="n">num_minibatches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;minibatches&quot;</span><span class="p">])</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>    <span class="n">num_revisions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">])</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>    <span class="k">if</span> <span class="n">num_revisions</span> <span class="o">&lt;</span> <span class="n">num_minibatches</span><span class="p">:</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>        <span class="k">return</span> <span class="s2">&quot;update_taxonomy&quot;</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="k">return</span> <span class="s2">&quot;review_taxonomy&quot;</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="s2">&quot;update_taxonomy&quot;</span><span class="p">,</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>    <span class="n">should_review</span><span class="p">,</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="c1"># Optional (but required for the diagram to be drawn correctly below)</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>    <span class="p">{</span><span class="s2">&quot;update_taxonomy&quot;</span><span class="p">:</span> <span class="s2">&quot;update_taxonomy&quot;</span><span class="p">,</span> <span class="s2">&quot;review_taxonomy&quot;</span><span class="p">:</span> <span class="s2">&quot;review_taxonomy&quot;</span><span class="p">},</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="p">)</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;review_taxonomy&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;summarize&quot;</span><span class="p">)</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="n">app</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></code></pre></div>
<p>API Reference: <a href="https://langchain-ai.github.io/langgraph/reference/graphs/#langgraph.graph.state.StateGraph">StateGraph</a> | <a href="https://langchain-ai.github.io/langgraph/reference/constants/#langgraph.constants.START">START</a> | <a href="https://langchain-ai.github.io/langgraph/reference/constants/#langgraph.constants.END">END</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">()))</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="c1"># This requires some extra dependencies and is optional</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="k">pass</span>
</span></code></pre></div>
<p><img alt="" src="data:image/jpg;base64,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PBA5AgO2u5ILZg3HC/5Pxzy/DarDbtTWq2MoehrdlOBSmWGSRzqkioJIeWtazo2u6vGA61tKxVluyPh1x5zHJXWNlww7JKS3vqb0LhBTstPcrJWSunZK5rnM2uD9zNdNDqrW32QfC17g1vErEHOJ0AF+pdT/AOogv6KhU/H3hhVzxwQcR8SmmlcGMjjvlK5z3E6AACTUknyK+oKxjOlsyPILMzRsEborjAwa+Iycv3D/ADYpXf8AnVnVZtDe6s+yGraD0cFLSUGpboOkb0srtD5fFnjVmWiv79+6PxC07RERZ1RERAREQEREBERAREQEREBERAREQEREBERAREQEREBVy4wS45dqi80sD6iiqg3vjTwsc+Xc0BrZ42jUuIaA1zQNXNa3bzbtfY0V8GPJPdKYclNUUN7o46iCSCupX82SMIkYfJyPUv6720n5LB/lj7FE3DCLXW1clZE2e21shLpKm3VD6d0h001eGEB5005vB6h8AXN7R5vJlF+aPg6eI/8AONdctKdmK3jHT/4aliio6eB+6OCON3Vq1gBX2VW9pE/nTfv8+L1Se0ifzpv3+fF6pPZ0+PylNo3rSiyriPbrpi1ts89DlN5MlXerfQSdNNER0U1SyOTT7mPG2uOny6cirZ7SJ/Om/f58Xqk9nT4/KS0b1oc0PaWuALSNCD5Vz97aM/yWD/LH2Kv+0ifzpv3+fF6pPaRP5037/Pi9Uns6fH5SWjesIt1ICCKWEEeURhRl5yNtLUG224R117e3VlLu5RA9UkxHuGfKeZ00aCVxHBGzANqr9faqPTQsNcYt35zEGH/ipq0WSgsNKae30sdLETucIxze7+c49bj8p1KWpYNd808o6/8AbUaofOwWVlhtzaZshnlc98087hoZZXuLnvPwaknQeQaAcgFJIi44sU4pnFO2UCIiqCIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiIM941ECy41qSB7Z7P1fpsXyj/38K0JZ7xq17y41pp+M9n90B+WxfD/APPwLQkBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERBnnGwa2TGtXBv30Wfm4a/y2LktDWecbNO8mNa6j76LP1DX+WxLQ0BERAREQEREBERAREQEREBERAREQEREBERAREQEREBE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VH69O+1/8zbn2qj9ens/qj7sPUsm1F2X3yqr5oj+ueviLrfydPadch8pqqPT65TOMWOrgrqq73JkcNdUxsgZTRSF7YImlxALtBq8l5LiBoNGga7dzq47U8GK8xri2qYn8GxZERF5SoiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiDP+M41s2N8tfvmtHk1/lkfyH/AN+Uda0BZ7xqbusuNDQn757OeQ1/lsS0JAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQZ5xsIFkxrU6D20Wfya/y2JaGs+407jZcb2l4PtntGuwanTuyLX/AA+H5FoKAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIvlVVUFDTyVFTNHTwRjc+WVwa1o+Ek8gFMRfVA+qKrHilhwP40Wj84rYyD/xTwqYd50Wntkf2rvo9bgnlK2Wdy0oqt4VMO86LT2yP7U8KmHedFp7ZH9qaNW4J5SZZ3LSiq3hUw7zotPbI/tTwqYd50Wntkf2po1bgnlJlnctKKreFTDvOi09sj+1PCph3nRae2R/amjVuCeUmWdyg8fOJuGWdtktNxyyx0N0pcjtE89DU3KGOeFgqopC97HPDmtDdHanlpz6lq9hyC15TaoLpZblR3e2T7uiraCdk8Mm1xa7a9pIOjmkHQ8iCPIvAv8A2hHCWzcV71i+WYbdLZXXuWaO03KKCpYT0Tj9zndofcs5hzj1At+BetOEtdw+4ScN8exC2ZRaXUlppWwdJ3WwdI/m6SQ8+tz3Od/5k0atwTykyzuasiq3hUw7zotPbI/tTwqYd50Wntkf2po1bgnlJlnctKKreFTDvOi09sj+1PCph3nRae2R/amjVuCeUmWdy0oqt4VMO86LT2yP7U8KmHedFp7ZH9qaNW4J5SZZ3LSiq3hUw7zotPbI/tXdac4x6/VTaa3Xy311S4EthgqWPe4AanRoOp08qiaFXDF5wTbwlFpTaIi4IEREBERAREQEREBERAREQEREBERAREQFS8pcLhmdqt04ElJFRy1vQu5tdKJI2scR1HaC7QHXm7XrAKuipF898mh+aZvro1r7L8SZ7p/C0JRERaFRERAREQEREBERAREQEREBERAUffrbDdLVUQzN5hpfHIOT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QEREBfOop4quCSGeJk0MgLXxyNDmuB6wQesL6ImwVd3C7DXnU4nZCfm+L0V+eCzDPNKyfq+L0VaUWjSK3HPOVs071W8FmGeaVk/V8Xop4LMM80rJ+r4vRVpRNIrcc85M071W8FmGeaVk/V8Xop4LMM80rJ+r4vRVpRNIrcc85M071W8FmGeaVk/V8Xop4LMM80rJ+r4vRVpRNIrcc85M072O8XOHeLW60Y++kx21Ub5MitUMjoaOJhfG6rja9hOg1a4Egjyg6aHqV58FmGeaVk/V8XoqH40EizY3tO0+2e0Dy9XdkXwf+/hWgppFbjnnJmneq3gswzzSsn6vi9FPBZhnmlZP1fF6KtKJpFbjnnJmneq3gswzzSsn6vi9FPBZhnmlZP1fF6KtKJpFbjnnJmneq3gswzzSsn6vi9FPBZhnmlZP1fF6KtKJpFbjnnJmneq3gswzzSsn6vi9Fd9owrHrBUCe2WK22+cagS0tJHG4a9fNoB5qaRRNerii045mPGUXneIiLggREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREGe8agXWXGtGdJ989nOnPl/psXPl8HWtCWe8a2l9lxoBrn/fRZzo39Ni5rQkBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERBnvGkB1lxrUA/fPZz42v5ZF8H/wAfCtCXiH2fXH7iRwZyTGaW3WqxV2K1dTTXGiqamlndOKymlbIYXubMAQSGHk0Ha7TXUar1fwivGT5Dw0x66ZlSUVBktbStqKylt8b44YS8lzWBr3OcCGFodqT42v5kFvREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQF/MkjYY3yPcGsaC5zj5AF/S4b5/sW4fo8n7JVsMXmIFNp6y+ZVSxXKO9VFjpalglp6Wjghc5kZALTI6WN+ryOZAAA1056bj/Xee++el47PQ/uy/vDvxRsf6DB9W1TC9fFMYMU4YwxaO6Oi0zaUJ3nvvnpeOz0P7snee++el47PQ/uym0Vc/0x9sdC6E7z33z0vHZ6H92TvPffPS8dnof3ZTaJn+mPtjoXQnee++el47PQ/uyd57756Xjs9D+7KbRM/0x9sdC6E7z33z0vHZ6H92TvPffPS8dnof3ZTaJn+mPtjoXZ7nvBul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FoAIbpqAApFEsIGy4BjGN1lbV2jHLRaquu1FVPRUMUMlRqdT0jmtBdz+HVdEWI2KCitVHHZbdHSWl7ZbfTspYxHRva0ta6FumkZDXOaC3TQOI8qlkQQUeB4zDkr8ijx20x5A8aOuzaGIVThppoZdu7q5da+suHWCegr6GWx22Sir6juurpn0kZjqZ9Wu6WRumj36sYdx1OrQdeQUwiCCyHGnV0dfW2aSjs2T1FKKOO+PoWVEscYcXNaQS0vaC55DS7QFxPwrk4a4BRcM8Po7DRTSVYifLPPVztaJKmeWR0ksrg0AAue9x0A0A0A5BWhEsCiaP3zrf8z1f11MpZRVE0niZQEaaNtFUDz6tZqfT/kf9y6YdmLwn8LQvCIi8lUREQEREBERAREQEREBERAREQEREFMfh14tf3Gx3Ojit4/BUtfSvlMA/mte2RviDyAgkdWugAX8d4Mw+NLH2Cb1yuyLXHaqnztP7QtdSe8GYfGlj7BN65O8GYfGlj7BN65XZFOlVN0coLqT3gzD40sfYJvXJ3gzD40sfYJvXK7ImlVN0coLqT3gzD40sfYJvXJ3gzD40sfYJvXK7ImlVN0coLqT3gzD40sfYJvXJ3gzD40sfYJvXK7ImlVN0coLspzSty7D6K21Dqqy1fdlzo7aGtopm7DPM2Lf+FOu3drp5dPIrB3gzD40sfYJvXLj41vDLLjRI11yizjyeWti+ELQk0qpujlBdSe8GYfGlj7BN65O8GYfGlj7BN65XZE0qpujlBdSe8GYfGlj7BN65O8GYfGlj7BN65XZE0qpujlBdSe8GYfGlj7BN65O8GYfGlj7BN65XZE0qpujlBdSe8GYfGlj7BN65O8GYfGlj7BN65XZE0qpujlBdSRYMv1Gt0smnl0oJvXKax7Gn2maatrasXC6TtbHJO2Poo2MGpDI2au2t1JJ1c4knmSA0NnEVMfaMeOMs2t3REIuIiLMgREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQZ7xqcW2XGtH7Pvns411I1/02Lly+HqWhLPeNbyyy40QNdcos46yOutiC0JAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQZ5xr07yY1rt09tFn91r+WxfAtDXnD2TXslOHeAXSz4xfshktd8o7za7lNT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" /></p>
<h2 id="use-the-graph">Use the graph<a class="headerlink" href="#use-the-graph" title="Permanent link">&para;</a></h2>
<p>The docs can contain <strong>any</strong> content, but we've found it works really well on chat bot logs, such as those captured by <a href="https://smith.langchain.com">LangSmith</a>.</p>
<p>We will use that as an example below. Update the <code>project_name</code> to your own LangSmith project.</p>
<p>You will likely have to customize the <code>run_to_doc</code> function below, since your expected keys may differ from those of this notebook's author.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langsmith</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">project_name</span> <span class="o">=</span> <span class="s2">&quot;YOUR PROJECT NAME&quot;</span>  <span class="c1"># Update to your own project</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">past_week</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="n">runs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="n">client</span><span class="o">.</span><span class="n">list_runs</span><span class="p">(</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>        <span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;eq(is_root, true)&quot;</span><span class="p">,</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="n">start_time</span><span class="o">=</span><span class="n">past_week</span><span class="p">,</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="c1"># We only need to return the inputs + outputs</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="n">select</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">],</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="p">)</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="p">)</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="c1"># Convert the langsmith traces to our graph&#39;s Doc object.</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_to_doc</span><span class="p">(</span><span class="n">run</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Doc</span><span class="p">:</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="n">turns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="k">for</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chat_history&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">turn</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>        <span class="n">turns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> idx=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>    <span class="n">turns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="s2">&lt;human idx=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&gt;</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="si">{</span><span class="n">run</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="s2">&lt;/human&gt;&quot;&quot;&quot;</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="p">)</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>    <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">outputs</span> <span class="ow">and</span> <span class="n">run</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]:</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>        <span class="n">turns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;ai idx=</span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&gt;</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="si">{</span><span class="n">run</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="si">}</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="s2">&lt;/ai&gt;&quot;&quot;&quot;</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>        <span class="p">)</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">turns</span><span class="p">)),</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>    <span class="p">}</span>
</span></code></pre></div>
<h4 id="invoke">Invoke<a class="headerlink" href="#invoke" title="Permanent link">&para;</a></h4>
<p>Now convert the runs to docs and kick off your graph flow. This will take some time! The summary step takes the longest. If you want to speed things up, you could try splitting the load across model providers.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryCache</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.globals</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_llm_cache</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># Optional. If you are running into errors or rate limits and want to avoid repeated computation,</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="c1"># you can set this while debugging</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="n">set_llm_cache</span><span class="p">(</span><span class="n">InMemoryCache</span><span class="p">())</span>
</span></code></pre></div>
<p>API Reference: <a href="https://python.langchain.com/api_reference/community/cache/langchain_community.cache.InMemoryCache.html">InMemoryCache</a> | <a href="https://python.langchain.com/api_reference/langchain/globals/langchain.globals.set_llm_cache.html">set_llm_cache</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># We will randomly sample down to 1K docs to speed things up</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">run_to_doc</span><span class="p">(</span><span class="n">run</span><span class="p">)</span> <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span> <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">docs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">),</span> <span class="mi">1000</span><span class="p">))</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">use_case</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="s2">&quot;Generate the taxonomy that can be used both to label the user intent&quot;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="s2">&quot; as well as to identify any required documentation (references, how-tos, etc.)&quot;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="s2">&quot; that would benefit the user.&quot;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="p">)</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="n">stream</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="p">{</span><span class="s2">&quot;documents&quot;</span><span class="p">:</span> <span class="n">docs</span><span class="p">},</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="p">{</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>            <span class="s2">&quot;use_case&quot;</span><span class="p">:</span> <span class="n">use_case</span><span class="p">,</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>            <span class="c1"># Optional:</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>            <span class="s2">&quot;suggestion_length&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>            <span class="s2">&quot;cluster_name_length&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>            <span class="s2">&quot;cluster_description_length&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>            <span class="s2">&quot;explanation_length&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>            <span class="s2">&quot;max_num_clusters&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>        <span class="p">},</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>        <span class="c1"># We batch summarize the docs. To avoid getting errors, we will limit the</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>        <span class="c1"># degree of parallelism to permit.</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>        <span class="s2">&quot;max_concurrency&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>    <span class="p">},</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="p">)</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>    <span class="n">node</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; ...&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="final-result">Final Result<a class="headerlink" href="#final-result" title="Permanent link">&para;</a></h2>
<p>Below, render the final result as markdown:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Markdown</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">format_taxonomy_md</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="n">md</span> <span class="o">=</span> <span class="s2">&quot;## Final Taxonomy</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="n">md</span> <span class="o">+=</span> <span class="s2">&quot;| ID | Name | Description |</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="n">md</span> <span class="o">+=</span> <span class="s2">&quot;|----|------|-------------|</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    <span class="c1"># Fill the table with cluster data</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="nb">id</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>            <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">|&quot;</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>        <span class="p">)</span>  <span class="c1"># Escape any pipe characters within the content</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>        <span class="n">description</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>            <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">|&quot;</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>        <span class="p">)</span>  <span class="c1"># Escape any pipe characters</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>        <span class="n">md</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="k">return</span> <span class="n">md</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="n">Markdown</span><span class="p">(</span><span class="n">format_taxonomy_md</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;__end__&quot;</span><span class="p">][</span><span class="s2">&quot;clusters&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span></code></pre></div>
<h2 id="final-taxonomy">Final Taxonomy<a class="headerlink" href="#final-taxonomy" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Troubleshooting Network Connectivity Issues</td>
<td>Resolving problems with DNS, network connections, and GitHub extension activation.</td>
</tr>
<tr>
<td>2</td>
<td>Extracting and Analyzing Data</td>
<td>Retrieving and processing data from various sources like text files, databases, and APIs.</td>
</tr>
<tr>
<td>3</td>
<td>Providing Healthcare Insights</td>
<td>Generating medical diagnosis, symptom checking, drug information, and skin condition analysis.</td>
</tr>
<tr>
<td>4</td>
<td>Configuring and Optimizing Models</td>
<td>Adjusting model parameters and hyperparameters to improve performance for a given task.</td>
</tr>
<tr>
<td>5</td>
<td>Generating Creative Poetry</td>
<td>Creating poems using language models and AI-powered tools.</td>
</tr>
<tr>
<td>6</td>
<td>Interacting with Databases</td>
<td>Querying databases, extracting data, and managing errors during data processing.</td>
</tr>
<tr>
<td>7</td>
<td>Querying Vector Databases</td>
<td>Interacting with vector databases like Milvus to store and retrieve high-dimensional data.</td>
</tr>
<tr>
<td>8</td>
<td>Generating Synthetic Data</td>
<td>Creating synthetic data using language models and machine learning techniques.</td>
</tr>
<tr>
<td>9</td>
<td>Integrating Tools and Workflows</td>
<td>Incorporating various tools and libraries into a cohesive workflow for different tasks.</td>
</tr>
<tr>
<td>10</td>
<td>Improving Information Retrieval</td>
<td>Storing and querying multiple vectors per document for better semantic understanding.</td>
</tr>
<tr>
<td>11</td>
<td>Processing Documents and Extracting Text</td>
<td>Parsing and extracting text from various document formats like PDF, DOCX, and HTML.</td>
</tr>
<tr>
<td>12</td>
<td>Building Local Knowledge Bases</td>
<td>Creating knowledge bases from text files, handling text splitting, embeddings, and storage.</td>
</tr>
<tr>
<td>13</td>
<td>Optimizing Conversational Retrieval</td>
<td>Troubleshooting and improving the performance of the ConversationalRetrievalChain in LangChain.</td>
</tr>
<tr>
<td>14</td>
<td>Connecting Databases and Using Agents</td>
<td>Connecting to databases, using agents, and understanding the differences between agent types.</td>
</tr>
<tr>
<td>15</td>
<td>Introspecting LangChain Tools</td>
<td>Accessing and retrieving details about the functions and source code of LangChain tools.</td>
</tr>
<tr>
<td>16</td>
<td>Generating Styled Answers with Retrieval Augmentation</td>
<td>Creating a QA system that generates well-cited answers in a specific style.</td>
</tr>
<tr>
<td>17</td>
<td>Using ZERO_SHOT_REACT_DESCRIPTION Agents</td>
<td>Applying the ZERO_SHOT_REACT_DESCRIPTION agent type in LangChain for chat models.</td>
</tr>
<tr>
<td>18</td>
<td>Automating Microlearning Course Creation</td>
<td>Generating microlearning courses based on input parameters like topic, volume, and learning style.</td>
</tr>
<tr>
<td>19</td>
<td>Integrating with Chroma Vector Store</td>
<td>Storing and retrieving data in the Chroma vector database, including handling document embeddings.</td>
</tr>
<tr>
<td>20</td>
<td>Managing LangChain Callback Tokens</td>
<td>Understanding and utilizing the callback token feature in the LCEL chain.</td>
</tr>
<tr>
<td>21</td>
<td>Troubleshooting FastAPI Deployments</td>
<td>Resolving issues with deploying a React app with a FastAPI backend.</td>
</tr>
<tr>
<td>22</td>
<td>Analyzing Data with LangChain Agents</td>
<td>Using LangChain agents to interact with Pandas and Spark DataFrames for data exploration.</td>
</tr>
<tr>
<td>23</td>
<td>Implementing the OpenAI Chat API</td>
<td>Implementing the OpenAI chat completion API and understanding the required inputs and outputs.</td>
</tr>
<tr>
<td>24</td>
<td>Comparing LangChain and LLMIndex</td>
<td>Evaluating the differences between LangChain and LLMIndex, including their UI support for Markdown.</td>
</tr>
<tr>
<td>25</td>
<td>Suppressing Tools in AgentExecutor</td>
<td>Temporarily disabling tools in an AgentExecutor for a fixed number of invocations.</td>
</tr>
</tbody>
</table>
<h2 id="phase-2-labeling">Phase 2: Labeling<a class="headerlink" href="#phase-2-labeling" title="Permanent link">&para;</a></h2>
<p>Now that we have our taxonomy, it's time to label a subset of our data to train a classifier.</p>
<p>Input classification can be useful for anything from in-line prompt optimization (tailor the prompt for each classified intent), to system improvements (identifying categories for which the system doesn't produce good responses) to product analytics (understand which intent categories could be improved to drive profits).</p>
<p>The problem is that LLM-based tagging can be expensive.</p>
<p>Embeddings can be ~100x cheaper to compute, and a simple logistic regression classifier on top of that would add negligible cost.</p>
<p>Let's tag and train a classifier!</p>
<h4 id="label-training-data">Label Training Data<a class="headerlink" href="#label-training-data" title="Permanent link">&para;</a></h4>
<p>Use an LLM to label the data in a fully-automated fashion. For better accuracy, you can sample a portion of the results to label by hand as well to verify the quality.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">labeling_prompt</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s2">&quot;wfh/tnt-llm-classify&quot;</span><span class="p">)</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">labeling_llm</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-haiku-20240307&quot;</span><span class="p">,</span> <span class="n">max_tokens_to_sample</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">labeling_llm_chain</span> <span class="o">=</span> <span class="p">(</span><span class="n">labeling_prompt</span> <span class="o">|</span> <span class="n">labeling_llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">())</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;ClassifyDocs&quot;</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="p">)</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_labels</span><span class="p">(</span><span class="n">output_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the generated labels from the predictions.&quot;&quot;&quot;</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="n">category_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="sa">r</span><span class="s2">&quot;\s*&lt;category&gt;(.*?)&lt;/category&gt;.*&quot;</span><span class="p">,</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>        <span class="n">output_text</span><span class="p">,</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="p">)</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>    <span class="n">categories</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span> <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">category_matches</span><span class="p">]</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple selected categories: </span><span class="si">{</span><span class="n">categories</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>    <span class="n">label</span> <span class="o">=</span> <span class="n">categories</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="n">stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d+\.\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">stripped</span><span class="p">}</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="n">labeling_chain</span> <span class="o">=</span> <span class="n">labeling_llm_chain</span> <span class="o">|</span> <span class="n">parse_labels</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">final_taxonomy</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;__end__&quot;</span><span class="p">][</span><span class="s2">&quot;clusters&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">xml_taxonomy</span> <span class="o">=</span> <span class="n">format_taxonomy</span><span class="p">(</span><span class="n">final_taxonomy</span><span class="p">)</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">results</span> <span class="o">=</span> <span class="n">labeling_chain</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="p">[</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>        <span class="p">{</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>            <span class="s2">&quot;taxonomy&quot;</span><span class="p">:</span> <span class="n">xml_taxonomy</span><span class="p">,</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>        <span class="p">}</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="p">],</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="p">{</span><span class="s2">&quot;max_concurrency&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="p">)</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="c1"># Update the docs to include the categories</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="n">updated_docs</span> <span class="o">=</span> <span class="p">[{</span><span class="o">**</span><span class="n">doc</span><span class="p">,</span> <span class="o">**</span><span class="n">category</span><span class="p">}</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">results</span><span class="p">)]</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">if</span> <span class="s2">&quot;OPENAI_API_KEY&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;Enter your OPENAI_API_KEY: &quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="c1"># Consider using other embedding models here too!</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="n">encoder</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;text-embedding-3-large&quot;</span><span class="p">)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">vectors</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">embed_documents</span><span class="p">([</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">])</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="n">embedded_docs</span> <span class="o">=</span> <span class="p">[{</span><span class="o">**</span><span class="n">doc</span><span class="p">,</span> <span class="s2">&quot;embedding&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">updated_docs</span><span class="p">,</span> <span class="n">vectors</span><span class="p">)]</span>
</span></code></pre></div>
<p>API Reference: <a href="https://python.langchain.com/api_reference/openai/embeddings/langchain_openai.embeddings.base.OpenAIEmbeddings.html">OpenAIEmbeddings</a></p>
<h4 id="train-classifier">Train Classifier<a class="headerlink" href="#train-classifier" title="Permanent link">&para;</a></h4>
<p>Now that we've extracted the features from the text, we can generate the classifier on them.</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">class_weight</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="c1"># Create a dictionary mapping category names to their indices in the taxonomy</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="n">category_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_taxonomy</span><span class="p">)}</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="n">category_to_index</span><span class="p">[</span><span class="s2">&quot;Other&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_to_index</span><span class="p">)</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="c1"># Convert category strings to numeric labels</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>    <span class="n">category_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">],</span> <span class="n">category_to_index</span><span class="p">[</span><span class="s2">&quot;Other&quot;</span><span class="p">])</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">embedded_docs</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="p">]</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="n">label_vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">embedded_docs</span><span class="p">]</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>    <span class="n">label_vectors</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="p">)</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="c1"># Calculate class weights</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="n">class_weights</span> <span class="o">=</span> <span class="n">class_weight</span><span class="o">.</span><span class="n">compute_class_weight</span><span class="p">(</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>    <span class="n">class_weight</span><span class="o">=</span><span class="s2">&quot;balanced&quot;</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="p">)</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="n">class_weight_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">class_weights</span><span class="p">))</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="c1"># Weight the classes to partially handle imbalanced data</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="n">class_weight_dict</span><span class="p">)</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="n">train_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="n">test_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="n">train_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">)</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="n">test_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">test_preds</span><span class="p">)</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a><span class="n">train_f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">)</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="n">test_f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">test_preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">)</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Accuracy: </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train F1 Score: </span><span class="si">{</span><span class="n">train_f1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test F1 Score: </span><span class="si">{</span><span class="n">test_f1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-output highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="go">Train Accuracy: 0.515</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="go">Test Accuracy: 0.330</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="go">Train F1 Score: 0.493</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="go">Test F1 Score: 0.335</span>
</span></code></pre></div></p>
<h2 id="phase-3-deploy">Phase 3: Deploy<a class="headerlink" href="#phase-3-deploy" title="Permanent link">&para;</a></h2>
<p>Now that you have your classifier, you can easily deploy it and apply to future runs! All you need is to embed the input and apply your LogisticRegression classifier. Let's try it. We will use python's <a href="https://joblib.readthedocs.io/en/stable/">joblib</a> library to serialize our sklearn classifier. Below is an example:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">dump</span> <span class="k">as</span> <span class="n">jl_dump</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">categories</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">category_to_index</span><span class="p">)</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="c1"># Save the model and categories to a file</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;model.joblib&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="n">jl_dump</span><span class="p">((</span><span class="n">model</span><span class="p">,</span> <span class="n">categories</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="to-deploy">To deploy<a class="headerlink" href="#to-deploy" title="Permanent link">&para;</a></h4>
<p>When deploying, you can load the classifier and initialize your embeddings encoder. They fit together easily using LCEL:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">jl_load</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">loaded_model</span><span class="p">,</span> <span class="n">loaded_categories</span> <span class="o">=</span> <span class="n">jl_load</span><span class="p">(</span><span class="s2">&quot;model.joblib&quot;</span><span class="p">)</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="n">encoder</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;text-embedding-3-large&quot;</span><span class="p">)</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_category_name</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">loaded_categories</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span> <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="n">classifier</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>    <span class="n">RunnableLambda</span><span class="p">(</span><span class="n">encoder</span><span class="o">.</span><span class="n">embed_documents</span><span class="p">,</span> <span class="n">encoder</span><span class="o">.</span><span class="n">aembed_documents</span><span class="p">)</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>    <span class="o">|</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>    <span class="o">|</span> <span class="n">get_category_name</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="p">)</span>
</span></code></pre></div>
<p>API Reference: <a href="https://python.langchain.com/api_reference/openai/embeddings/langchain_openai.embeddings.base.OpenAIEmbeddings.html">OpenAIEmbeddings</a></p>
<h4 id="example">Example:<a class="headerlink" href="#example" title="Permanent link">&para;</a></h4>
<p>Assuming you've had some more data come in, you can fetch it and apply it below</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">past_5_min</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">runs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    <span class="n">client</span><span class="o">.</span><span class="n">list_runs</span><span class="p">(</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>        <span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>        <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;eq(is_root, true)&quot;</span><span class="p">,</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>        <span class="n">start_time</span><span class="o">=</span><span class="n">past_5_min</span><span class="p">,</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>        <span class="c1"># We only need to return the inputs + outputs</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>        <span class="n">select</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">],</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>        <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>    <span class="p">)</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="p">)</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">run_to_doc</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">]</span>
</span></code></pre></div>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">classes</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">invoke</span><span class="p">([</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">])</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">classes</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
</span></code></pre></div>
<div class="language-output highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="go">INFO:httpx:HTTP Request: POST https://api.openai.com/v1/embeddings &quot;HTTP/1.1 200 OK&quot;</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="go">``````output</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="go">[&#39;Interacting with Databases&#39;, &#39;Optimizing Conversational Retrieval&#39;]</span>
</span></code></pre></div></p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>Congrats on implementing TNT-LLM! While most folks use clustering-based approaches like LDA, k-means, etc. it can often be hard to really interpret what each cluster represents. TNT-LLM generates human-interpretable labels you can use downstream to monitor and improve your application.</p>
<p>The technique also lends itself to hierarchical sub-categorizing: once you have the above taxonomy, use it to label your data, then on each sub-category, generate a new taxonomy using a similar technique to the one described above!</p>









  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Please help us improve this page by adding to the discussion below.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


  <h2 id="__comments">Comments</h2>
  <script src="https://giscus.app/client.js"
        data-repo="langchain-ai/langgraph"
        data-repo-id="R_kgDOKFU0lQ"
        data-category="Discussions"
        data-category-id="DIC_kwDOKFU0lc4CfZgA"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

                

              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../storm/storm/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Web Research (STORM)">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Web Research (STORM)
              </div>
            </div>
          </a>
        
        
          
          <a href="../../web-navigation/web_voyager/" class="md-footer__link md-footer__link--next" aria-label="Next: Web Voyager">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Web Voyager
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 LangChain, Inc | <a href="#__consent">Consent Preferences</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs Insiders
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://langchain-ai.github.io/langgraphjs/" target="_blank" rel="noopener" title="langchain-ai.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 32v448h448V32zm243.8 349.4c0 43.6-25.6 63.5-62.9 63.5-33.7 0-53.2-17.4-63.2-38.5l34.3-20.7c6.6 11.7 12.6 21.6 27.1 21.6 13.8 0 22.6-5.4 22.6-26.5V237.7h42.1zm99.6 63.5c-39.1 0-64.4-18.6-76.7-43l34.3-19.8c9 14.7 20.8 25.6 41.5 25.6 17.4 0 28.6-8.7 28.6-20.8 0-14.4-11.4-19.5-30.7-28l-10.5-4.5c-30.4-12.9-50.5-29.2-50.5-63.5 0-31.6 24.1-55.6 61.6-55.6 26.8 0 46 9.3 59.8 33.7L368 290c-7.2-12.9-15-18-27.1-18-12.3 0-20.1 7.8-20.1 18 0 12.6 7.8 17.7 25.9 25.6l10.5 4.5c35.8 15.3 55.9 31 55.9 66.2 0 37.8-29.8 58.6-69.7 58.6"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/langchain-ai/langgraph" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/LangChainAI" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  


  
    
  




  

<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. <strong>Clicking "Accept" makes our documentation better. Thank you!</strong> ❤️</p>
<input class="md-toggle" type="checkbox" id="__settings" checked>
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
      <button type="reset" class="md-button md-button--primary">Reject</button>
    
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.action.edit", "content.tooltips", "header.autohide", "navigation.indexes", "navigation.expand", "navigation.footer", "navigation.instant", "navigation.sections", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.c7c1ca2c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.203fd0bc.min.js"></script>
      
    
  </body>
</html>