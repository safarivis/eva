
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Build language agents as graphs">
      
      
      
        <link rel="canonical" href="https://langchain-ai.github.io/langgraph/tutorials/extraction/retries/">
      
      
        <link rel="prev" href="../../usaco/usaco/">
      
      
        <link rel="next" href="../../auth/getting_started/">
      
      
        
      
      
      <link rel="icon" href="../../../static/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44+insiders-4.53.14">
    
    
  
    <title>Complex data extraction with function calling</title>
  

    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.12320a83.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Public+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Public Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-G8X6ELZYE0"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-G8X6ELZYE0",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-G8X6ELZYE0",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Public+Sans&display=swap");
    :root {
      --md-primary-fg-color: #333333;
      --md-accent-fg-color: #1E88E5;
      --md-default-bg-color: #FFFFFF;
      --md-default-fg-color: #333333;
      --md-text-font-family: "Public Sans", sans-serif;
    }

    body {
      font-family: var(--md-text-font-family);
      background-color: var(--md-default-bg-color);
      color: var(--md-default-fg-color);
    }

    .md-main {
      background-color: #FFFFFF;
    }

    .md-footer {
      background-color: #F5F5F5;
      color: #666666;
    }

    .md-footer-meta {
      background-color: #EEEEEE;
    }

    .md-typeset a {
      color: #1E88E5;
    }

    .md-typeset a:hover {
      color: #1565C0;
    }

    .md-nav__link--active,
    .md-nav__link:active {
      color: #1E88E5;
    }

    .md-search__input {
      background-color: #F5F5F5;
      color: #333333;
    }

    .md-search__input:hover,
    .md-search__input:focus {
      background-color: #EEEEEE;
    }
    /* Table of contents styles */
    .md-nav--secondary .md-nav__item--active > .md-nav__link {
      font-weight: bold;
      color: var(--md-primary-fg-color);
    }

    .md-nav--secondary .md-nav__item--nested > .md-nav__link {
      font-weight: normal;
      color: var(--md-default-fg-color);
    }

    .md-nav--secondary .md-nav__item--nested > .md-nav__link::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 6px;
      background-color: var(--md-default-fg-color);
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    [data-md-color-scheme="slate"] {
      --md-default-bg-color: #1E1E1E;
      --md-default-fg-color: #FFFFFF;
      --md-accent-fg-color: #64B5F6;
    }

    [data-md-color-scheme="slate"] .md-main {
      background-color: #1E1E1E;
    }

    [data-md-color-scheme="slate"] .navbar {
      background-color: #1E1E1E;
      color: #FFFFFF;
      box-shadow: none;
    }

    [data-md-color-scheme="slate"] .md-footer {
      background-color: #1E1E1E;
      color: #BDBDBD;
    }

    [data-md-color-scheme="slate"] .md-header {
      background-color: #1E1E1E;
      color: #BDBDBD;
    }

    [data-md-color-scheme="slate"] .md-tabs {
      background-color: #1E1E1E;
      color: #BDBDBD;
    }

    [data-md-color-scheme="slate"] .md-search__input {
      background-color: #F5F5F5;
      color: #333333;
    }

    [data-md-color-scheme="slate"] .md-search__icon {
      color: #333333;
    }

    [data-md-color-scheme="slate"] .md-search__input::placeholder {
      color: #333333;
    }

    [data-md-color-scheme="slate"] .md-footer-meta {
      background-color: #1E1E1E;
    }

    [data-md-color-scheme="slate"] .md-typeset a {
      color: #64B5F6;
    }

    [data-md-color-scheme="slate"] .md-typeset a:hover {
      color: #90CAF9;
    }

    .notebook-links {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }
    .notebook-links .md-content__button {
      margin-left: 0.5rem;
    }

    [data-md-color-scheme=default] .logo-dark {
      display: none !important;
    }

    [data-md-color-scheme=slate] .logo-light {
      display: none !important;
    }

    .jupyter-wrapper .jp-CodeCell .jp-Cell-inputWrapper .jp-InputPrompt.jp-InputArea-prompt {
      display: none !important;
    }

    .jupyter-wrapper .jp-Notebook .jp-Cell .jp-OutputPrompt {
      display: none !important;
    }

    .md-banner {
      background-color: #CFC9FA;
      color: #000000;
    }

    .md-banner a {
      color: #000000;
      text-decoration: underline;
    }

    .md-banner a:hover {
      color: #000000;
    }

    /* Dark mode banner links */
    [data-md-color-scheme="slate"] .md-banner a {
      color: #000000;
    }

    [data-md-color-scheme="slate"] .md-banner a:hover {
      color: #000000;
    }

    /* control the navbar depth */
    [data-md-level="2"] .md-nav {
      display: none;
    }

    /* disable the collapse/expand icon in the navar */
    .md-nav__icon {
      display: none;
    }
  </style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="gray">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#complex-data-extraction-with-function-calling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            
            
  <b>Join us at <a href="https://interrupt.langchain.com/" target="_blank" rel="noopener noreferrer"> Interrupt: The Agent AI Conference by LangChain</a> on May 13 & 14 in San Francisco!</b>

          </div>
          
            <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="" class="md-header__button md-logo" aria-label="" data-md-component="logo">
      
  <img src="../../../static/wordmark_dark.svg" alt="logo" class="logo-light" />
  <img src="../../../static/wordmark_light.svg" alt="logo" class="logo-dark" />

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Complex data extraction with function calling
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="gray"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="white"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/langchain-ai/langgraph" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../.." class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../reference/graphs/" class="md-tabs__link">
          
  
    
  
  API reference

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="" class="md-nav__button md-logo" aria-label="" data-md-component="logo">
      
  <img src="../../../static/wordmark_dark.svg" alt="logo" class="logo-light" />
  <img src="../../../static/wordmark_light.svg" alt="logo" class="logo-dark" />

    </a>
    
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/langchain-ai/langgraph" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Home
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Get started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Get started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Learn the basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../deployment/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" checked>
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../how-tos/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    How-to Guides
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../concepts/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1_3_3" id="__nav_1_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#quick-start" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#chatbots" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Chatbots
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#rag" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    RAG
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#agent-architectures" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Agent Architectures
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tutorials#evaluation" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Evaluation & Analysis
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_3_7" checked>
        
          
          <label class="md-nav__link" for="__nav_1_3_3_7" id="__nav_1_3_3_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Experimental
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_1_3_3_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Experimental
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials#experimental" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Experimental
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../storm/storm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Web Research (STORM)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tnt-llm/tnt-llm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    TNT-LLM: Text Mining at Scale
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../web-navigation/web_voyager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Web Voyager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usaco/usaco/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Competitive Programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    Complex data extraction with function calling
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    Complex data extraction with function calling
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#regular-extraction-with-retries" class="md-nav__link">
    <span class="md-ellipsis">
      
        Regular Extraction with Retries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Regular Extraction with Retries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-the-validator-retry-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Define the Validator + Retry Graph
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#try-it-out" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try it out
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Try it out">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nested-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Nested Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jsonpatch" class="md-nav__link">
    <span class="md-ellipsis">
      
        JSONPatch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JSONPatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#and-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        And it works!
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../concepts#langgraph-platform" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    LangGraph Platform
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Resources
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Resources
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../prebuilt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Prebuilt Agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adopters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Companies using LangGraph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../troubleshooting/errors/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://academy.langchain.com/courses/intro-to-langgraph" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    LangGraph Academy Course
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../reference/graphs/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    API reference
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#regular-extraction-with-retries" class="md-nav__link">
    <span class="md-ellipsis">
      
        Regular Extraction with Retries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Regular Extraction with Retries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-the-validator-retry-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Define the Validator + Retry Graph
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#try-it-out" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try it out
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Try it out">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nested-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Nested Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jsonpatch" class="md-nav__link">
    <span class="md-ellipsis">
      
        JSONPatch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JSONPatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#and-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        And it works!
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
      
        
  
    
    
      <li class="md-path__item">
        <a href="../../.." class="md-path__link">
          
  <span class="md-ellipsis">
    Home
  </span>

        </a>
      </li>
    
  

      
        
  
    
    
      
  
    
    
      <li class="md-path__item">
        <a href="../../../how-tos/" class="md-path__link">
          
  <span class="md-ellipsis">
    Guides
  </span>

        </a>
      </li>
    
  

    
  

      
        
  
    
    
      <li class="md-path__item">
        <a href="../../" class="md-path__link">
          
  <span class="md-ellipsis">
    Tutorials
  </span>

        </a>
      </li>
    
  

      
        
  
    
    
      <li class="md-path__item">
        <a href="../../../tutorials#experimental" class="md-path__link">
          
  <span class="md-ellipsis">
    Experimental
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
<div class="notebook-links">
  
</div>


                  


  
    <a href="https://github.com/langchain-ai/langgraph/edit/main/docs/docs/tutorials/extraction/retries.ipynb" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="complex-data-extraction-with-function-calling">Complex data extraction with function calling<a class="headerlink" href="#complex-data-extraction-with-function-calling" title="Permanent link">&para;</a></h1>
<p>Function calling is a core primitive for integrating LLMs within your software stack. We use it throughout the LangGraph docs, since developing with function calling (aka tool usage) tends to be much more stress-free than the traditional way of writing custom string parsers.</p>
<p>However, even GPT-4, Opus, and other powerful models still struggle with complex functions, especially if your schema involves any nesting or if you have more advanced data validation rules.</p>
<p>There are three basic ways to increase reliability: better prompting, constrained decoding, and <strong>validation with re-prompting</strong>.</p>
<p>We will cover two approaches to the last technique here, since it is generally applicable across any LLM that supports tool calling.</p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>First, let's install the required packages and set our API keys</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="o">%%</span><span class="n">capture</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">langchain</span><span class="o">-</span><span class="n">anthropic</span> <span class="n">langgraph</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="admonition tip">
    <p class="admonition-title">Set up <a href="https://smith.langchain.com">LangSmith</a> for LangGraph development</p>
    <p style="padding-top: 5px;">
        Sign up for LangSmith to quickly spot issues and improve the performance of your LangGraph projects. LangSmith lets you use trace data to debug, test, and monitor your LLM apps built with LangGraph — read more about how to get started <a href="https://docs.smith.langchain.com">here</a>. 
    </p>
</div>

<h2 id="regular-extraction-with-retries">Regular Extraction with Retries<a class="headerlink" href="#regular-extraction-with-retries" title="Permanent link">&para;</a></h2>
<p>Both examples here invoke a simple looping graph that takes following approach:
1. Prompt the LLM to respond.
2. If it responds with tool calls, validate those.
3. If the calls are correct, return. Otherwise, format the validation error as a new <a href="https://api.python.langchain.com/en/latest/messages/langchain_core.messages.tool.ToolMessage.html#langchain_core.messages.tool.ToolMessage">ToolMessage</a> and prompt the LLM to fix the errors. Taking us back to step (1).</p>
<p>The techniques differ only on step (3). In this first step, we will prompt the original LLM to regenerate the function calls to fix the validation errors. In the next section, we will instead prompt the LLM to generate a <strong>patch</strong> to fix the errors, meaning it doesn't have to re-generate data that is valid.</p>
<h3 id="define-the-validator-retry-graph">Define the Validator + Retry Graph<a class="headerlink" href="#define-the-validator-retry-graph" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">Annotated</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">Callable</span><span class="p">,</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">Dict</span><span class="p">,</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="n">List</span><span class="p">,</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">Literal</span><span class="p">,</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="n">Optional</span><span class="p">,</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">Sequence</span><span class="p">,</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">Type</span><span class="p">,</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="n">Union</span><span class="p">,</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="p">)</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.language_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseChatModel</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="n">AIMessage</span><span class="p">,</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="n">AnyMessage</span><span class="p">,</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>    <span class="n">BaseMessage</span><span class="p">,</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="n">HumanMessage</span><span class="p">,</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="n">ToolCall</span><span class="p">,</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="p">)</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.prompt_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptValue</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>    <span class="n">Runnable</span><span class="p">,</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>    <span class="n">RunnableLambda</span><span class="p">,</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="p">)</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_messages</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.prebuilt</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationNode</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">_default_aggregator</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AIMessage</span><span class="p">:</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ai&quot;</span><span class="p">:</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>            <span class="k">return</span> <span class="n">m</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No AI message found in the sequence.&quot;</span><span class="p">)</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">RetryStrategy</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The retry strategy for a tool call.&quot;&quot;&quot;</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>    <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The maximum number of attempts to make.&quot;&quot;&quot;</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>    <span class="n">fallback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="n">Union</span><span class="p">[</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>            <span class="n">Runnable</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">AIMessage</span><span class="p">],</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>            <span class="n">Runnable</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">BaseMessage</span><span class="p">],</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>            <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">]],</span> <span class="n">AIMessage</span><span class="p">],</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>        <span class="p">]</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>    <span class="p">]</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The function to use once validation fails.&quot;&quot;&quot;</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>    <span class="n">aggregate_messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">]],</span> <span class="n">AIMessage</span><span class="p">]]</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="k">def</span><span class="w"> </span><span class="nf">_bind_validator_with_retries</span><span class="p">(</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>    <span class="n">llm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="n">Runnable</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">AIMessage</span><span class="p">],</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>        <span class="n">Runnable</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span> <span class="n">BaseMessage</span><span class="p">],</span>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>    <span class="p">],</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>    <span class="n">validator</span><span class="p">:</span> <span class="n">ValidationNode</span><span class="p">,</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>    <span class="n">retry_strategy</span><span class="p">:</span> <span class="n">RetryStrategy</span><span class="p">,</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">PromptValue</span><span class="p">],</span> <span class="n">AIMessage</span><span class="p">]:</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Binds a tool validators + retry logic to create a runnable validation graph.</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a><span class="sd">    LLMs that support tool calling can generate structured JSON. However, they may not always</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a><span class="sd">    perfectly follow your requested schema, especially if the schema is nested or has complex</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a><span class="sd">    validation rules. This method allows you to bind a validation function to the LLM&#39;s output,</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a><span class="sd">    so that any time the LLM generates a message, the validation function is run on it. If</span>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a><span class="sd">    the validation fails, the method will retry the LLM with a fallback strategy, the simplest</span>
</span><span id="__span-2-76"><a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a><span class="sd">    being just to add a message to the output with the validation errors and a request to fix them.</span>
</span><span id="__span-2-77"><a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>
</span><span id="__span-2-78"><a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a><span class="sd">    The resulting runnable expects a list of messages as input and returns a single AI message.</span>
</span><span id="__span-2-79"><a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a><span class="sd">    By default, the LLM can optionally NOT invoke tools, making this easier to incorporate into</span>
</span><span id="__span-2-80"><a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a><span class="sd">    your existing chat bot. You can specify a tool_choice to force the validator to be run on</span>
</span><span id="__span-2-81"><a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a><span class="sd">    the outputs.</span>
</span><span id="__span-2-82"><a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a>
</span><span id="__span-2-83"><a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a><span class="sd">    Args:</span>
</span><span id="__span-2-84"><a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a><span class="sd">        llm (Runnable): The llm that will generate the initial messages (and optionally fallba)</span>
</span><span id="__span-2-85"><a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a><span class="sd">        validator (ValidationNode): The validation logic.</span>
</span><span id="__span-2-86"><a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a><span class="sd">        retry_strategy (RetryStrategy): The retry strategy to use.</span>
</span><span id="__span-2-87"><a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a><span class="sd">            Possible keys:</span>
</span><span id="__span-2-88"><a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a><span class="sd">            - max_attempts: The maximum number of attempts to make.</span>
</span><span id="__span-2-89"><a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a><span class="sd">            - fallback: The LLM or function to use in case of validation failure.</span>
</span><span id="__span-2-90"><a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a><span class="sd">            - aggregate_messages: A function to aggregate the messages over multiple turns.</span>
</span><span id="__span-2-91"><a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a><span class="sd">                Defaults to fetching the last AI message.</span>
</span><span id="__span-2-92"><a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a><span class="sd">        tool_choice: If provided, always run the validator on the tool output.</span>
</span><span id="__span-2-93"><a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a>
</span><span id="__span-2-94"><a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a><span class="sd">    Returns:</span>
</span><span id="__span-2-95"><a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a><span class="sd">        Runnable: A runnable that can be invoked with a list of messages and returns a single AI message.</span>
</span><span id="__span-2-96"><a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-2-97"><a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a>
</span><span id="__span-2-98"><a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_or_overwrite_messages</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="__span-2-99"><a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Append messages. If the update is a &#39;finalized&#39; output, replace the whole list.&quot;&quot;&quot;</span>
</span><span id="__span-2-100"><a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;finalize&quot;</span> <span class="ow">in</span> <span class="n">right</span><span class="p">:</span>
</span><span id="__span-2-101"><a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a>            <span class="n">finalized</span> <span class="o">=</span> <span class="n">right</span><span class="p">[</span><span class="s2">&quot;finalize&quot;</span><span class="p">]</span>
</span><span id="__span-2-102"><a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">finalized</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="__span-2-103"><a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>                <span class="n">finalized</span> <span class="o">=</span> <span class="p">[</span><span class="n">finalized</span><span class="p">]</span>
</span><span id="__span-2-104"><a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">finalized</span><span class="p">:</span>
</span><span id="__span-2-105"><a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-2-106"><a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>                    <span class="n">m</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="__span-2-107"><a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>            <span class="k">return</span> <span class="n">finalized</span>
</span><span id="__span-2-108"><a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
</span><span id="__span-2-109"><a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="__span-2-110"><a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a>            <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>
</span><span id="__span-2-111"><a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="__span-2-112"><a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a>
</span><span id="__span-2-113"><a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="__span-2-114"><a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_or_overwrite_messages</span><span class="p">]</span>
</span><span id="__span-2-115"><a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a>        <span class="n">attempt_number</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>
</span><span id="__span-2-116"><a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a>        <span class="n">initial_num_messages</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-2-117"><a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a>        <span class="n">input_format</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;dict&quot;</span><span class="p">]</span>
</span><span id="__span-2-118"><a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a>
</span><span id="__span-2-119"><a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a>    <span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span><span id="__span-2-120"><a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a>
</span><span id="__span-2-121"><a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dedict</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="__span-2-122"><a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the messages from the state.&quot;&quot;&quot;</span>
</span><span id="__span-2-123"><a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a>        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span>
</span><span id="__span-2-124"><a id="__codelineno-2-124" name="__codelineno-2-124" href="#__codelineno-2-124"></a>
</span><span id="__span-2-125"><a id="__codelineno-2-125" name="__codelineno-2-125" href="#__codelineno-2-125"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">dedict</span> <span class="o">|</span> <span class="n">llm</span> <span class="o">|</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">msg</span><span class="p">],</span> <span class="s2">&quot;attempt_number&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span id="__span-2-126"><a id="__codelineno-2-126" name="__codelineno-2-126" href="#__codelineno-2-126"></a>    <span class="n">fbrunnable</span> <span class="o">=</span> <span class="n">retry_strategy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallback&quot;</span><span class="p">)</span>
</span><span id="__span-2-127"><a id="__codelineno-2-127" name="__codelineno-2-127" href="#__codelineno-2-127"></a>    <span class="k">if</span> <span class="n">fbrunnable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-2-128"><a id="__codelineno-2-128" name="__codelineno-2-128" href="#__codelineno-2-128"></a>        <span class="n">fb_runnable</span> <span class="o">=</span> <span class="n">llm</span>
</span><span id="__span-2-129"><a id="__codelineno-2-129" name="__codelineno-2-129" href="#__codelineno-2-129"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fbrunnable</span><span class="p">,</span> <span class="n">Runnable</span><span class="p">):</span>
</span><span id="__span-2-130"><a id="__codelineno-2-130" name="__codelineno-2-130" href="#__codelineno-2-130"></a>        <span class="n">fb_runnable</span> <span class="o">=</span> <span class="n">fbrunnable</span>  <span class="c1"># type: ignore</span>
</span><span id="__span-2-131"><a id="__codelineno-2-131" name="__codelineno-2-131" href="#__codelineno-2-131"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-2-132"><a id="__codelineno-2-132" name="__codelineno-2-132" href="#__codelineno-2-132"></a>        <span class="n">fb_runnable</span> <span class="o">=</span> <span class="n">RunnableLambda</span><span class="p">(</span><span class="n">fbrunnable</span><span class="p">)</span>
</span><span id="__span-2-133"><a id="__codelineno-2-133" name="__codelineno-2-133" href="#__codelineno-2-133"></a>    <span class="n">fallback</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-2-134"><a id="__codelineno-2-134" name="__codelineno-2-134" href="#__codelineno-2-134"></a>        <span class="n">dedict</span> <span class="o">|</span> <span class="n">fb_runnable</span> <span class="o">|</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">msg</span><span class="p">],</span> <span class="s2">&quot;attempt_number&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span id="__span-2-135"><a id="__codelineno-2-135" name="__codelineno-2-135" href="#__codelineno-2-135"></a>    <span class="p">)</span>
</span><span id="__span-2-136"><a id="__codelineno-2-136" name="__codelineno-2-136" href="#__codelineno-2-136"></a>
</span><span id="__span-2-137"><a id="__codelineno-2-137" name="__codelineno-2-137" href="#__codelineno-2-137"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">count_messages</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-2-138"><a id="__codelineno-2-138" name="__codelineno-2-138" href="#__codelineno-2-138"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;initial_num_messages&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[]))}</span>
</span><span id="__span-2-139"><a id="__codelineno-2-139" name="__codelineno-2-139" href="#__codelineno-2-139"></a>
</span><span id="__span-2-140"><a id="__codelineno-2-140" name="__codelineno-2-140" href="#__codelineno-2-140"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;count_messages&quot;</span><span class="p">,</span> <span class="n">count_messages</span><span class="p">)</span>
</span><span id="__span-2-141"><a id="__codelineno-2-141" name="__codelineno-2-141" href="#__codelineno-2-141"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;llm&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</span><span id="__span-2-142"><a id="__codelineno-2-142" name="__codelineno-2-142" href="#__codelineno-2-142"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;fallback&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="p">)</span>
</span><span id="__span-2-143"><a id="__codelineno-2-143" name="__codelineno-2-143" href="#__codelineno-2-143"></a>
</span><span id="__span-2-144"><a id="__codelineno-2-144" name="__codelineno-2-144" href="#__codelineno-2-144"></a>    <span class="c1"># To support patch-based retries, we need to be able to</span>
</span><span id="__span-2-145"><a id="__codelineno-2-145" name="__codelineno-2-145" href="#__codelineno-2-145"></a>    <span class="c1"># aggregate the messages over multiple turns.</span>
</span><span id="__span-2-146"><a id="__codelineno-2-146" name="__codelineno-2-146" href="#__codelineno-2-146"></a>    <span class="c1"># The next sequence selects only the relevant messages</span>
</span><span id="__span-2-147"><a id="__codelineno-2-147" name="__codelineno-2-147" href="#__codelineno-2-147"></a>    <span class="c1"># and then applies the validator</span>
</span><span id="__span-2-148"><a id="__codelineno-2-148" name="__codelineno-2-148" href="#__codelineno-2-148"></a>    <span class="n">select_messages</span> <span class="o">=</span> <span class="n">retry_strategy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregate_messages&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_default_aggregator</span>
</span><span id="__span-2-149"><a id="__codelineno-2-149" name="__codelineno-2-149" href="#__codelineno-2-149"></a>
</span><span id="__span-2-150"><a id="__codelineno-2-150" name="__codelineno-2-150" href="#__codelineno-2-150"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">select_generated_messages</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="__span-2-151"><a id="__codelineno-2-151" name="__codelineno-2-151" href="#__codelineno-2-151"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Select only the messages generated within this loop.&quot;&quot;&quot;</span>
</span><span id="__span-2-152"><a id="__codelineno-2-152" name="__codelineno-2-152" href="#__codelineno-2-152"></a>        <span class="n">selected</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;initial_num_messages&quot;</span><span class="p">]</span> <span class="p">:]</span>
</span><span id="__span-2-153"><a id="__codelineno-2-153" name="__codelineno-2-153" href="#__codelineno-2-153"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">select_messages</span><span class="p">(</span><span class="n">selected</span><span class="p">)]</span>
</span><span id="__span-2-154"><a id="__codelineno-2-154" name="__codelineno-2-154" href="#__codelineno-2-154"></a>
</span><span id="__span-2-155"><a id="__codelineno-2-155" name="__codelineno-2-155" href="#__codelineno-2-155"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">endict_validator_output</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-2-156"><a id="__codelineno-2-156" name="__codelineno-2-156" href="#__codelineno-2-156"></a>        <span class="k">if</span> <span class="n">tool_choice</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
</span><span id="__span-2-157"><a id="__codelineno-2-157" name="__codelineno-2-157" href="#__codelineno-2-157"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-158"><a id="__codelineno-2-158" name="__codelineno-2-158" href="#__codelineno-2-158"></a>                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-2-159"><a id="__codelineno-2-159" name="__codelineno-2-159" href="#__codelineno-2-159"></a>                    <span class="n">HumanMessage</span><span class="p">(</span>
</span><span id="__span-2-160"><a id="__codelineno-2-160" name="__codelineno-2-160" href="#__codelineno-2-160"></a>                        <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ValidationError: please respond with a valid tool call [tool_choice=</span><span class="si">{</span><span class="n">tool_choice</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">,</span>
</span><span id="__span-2-161"><a id="__codelineno-2-161" name="__codelineno-2-161" href="#__codelineno-2-161"></a>                        <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;is_error&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="__span-2-162"><a id="__codelineno-2-162" name="__codelineno-2-162" href="#__codelineno-2-162"></a>                    <span class="p">)</span>
</span><span id="__span-2-163"><a id="__codelineno-2-163" name="__codelineno-2-163" href="#__codelineno-2-163"></a>                <span class="p">]</span>
</span><span id="__span-2-164"><a id="__codelineno-2-164" name="__codelineno-2-164" href="#__codelineno-2-164"></a>            <span class="p">}</span>
</span><span id="__span-2-165"><a id="__codelineno-2-165" name="__codelineno-2-165" href="#__codelineno-2-165"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
</span><span id="__span-2-166"><a id="__codelineno-2-166" name="__codelineno-2-166" href="#__codelineno-2-166"></a>
</span><span id="__span-2-167"><a id="__codelineno-2-167" name="__codelineno-2-167" href="#__codelineno-2-167"></a>    <span class="n">validator_runnable</span> <span class="o">=</span> <span class="n">select_generated_messages</span> <span class="o">|</span> <span class="n">validator</span> <span class="o">|</span> <span class="n">endict_validator_output</span>
</span><span id="__span-2-168"><a id="__codelineno-2-168" name="__codelineno-2-168" href="#__codelineno-2-168"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;validator&quot;</span><span class="p">,</span> <span class="n">validator_runnable</span><span class="p">)</span>
</span><span id="__span-2-169"><a id="__codelineno-2-169" name="__codelineno-2-169" href="#__codelineno-2-169"></a>
</span><span id="__span-2-170"><a id="__codelineno-2-170" name="__codelineno-2-170" href="#__codelineno-2-170"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Finalizer</span><span class="p">:</span>
</span><span id="__span-2-171"><a id="__codelineno-2-171" name="__codelineno-2-171" href="#__codelineno-2-171"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Pick the final message to return from the retry loop.&quot;&quot;&quot;</span>
</span><span id="__span-2-172"><a id="__codelineno-2-172" name="__codelineno-2-172" href="#__codelineno-2-172"></a>
</span><span id="__span-2-173"><a id="__codelineno-2-173" name="__codelineno-2-173" href="#__codelineno-2-173"></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">],</span> <span class="n">AIMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-2-174"><a id="__codelineno-2-174" name="__codelineno-2-174" href="#__codelineno-2-174"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_aggregator</span> <span class="o">=</span> <span class="n">aggregator</span> <span class="ow">or</span> <span class="n">_default_aggregator</span>
</span><span id="__span-2-175"><a id="__codelineno-2-175" name="__codelineno-2-175" href="#__codelineno-2-175"></a>
</span><span id="__span-2-176"><a id="__codelineno-2-176" name="__codelineno-2-176" href="#__codelineno-2-176"></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-2-177"><a id="__codelineno-2-177" name="__codelineno-2-177" href="#__codelineno-2-177"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Return just the AI message.&quot;&quot;&quot;</span>
</span><span id="__span-2-178"><a id="__codelineno-2-178" name="__codelineno-2-178" href="#__codelineno-2-178"></a>            <span class="n">initial_num_messages</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;initial_num_messages&quot;</span><span class="p">]</span>
</span><span id="__span-2-179"><a id="__codelineno-2-179" name="__codelineno-2-179" href="#__codelineno-2-179"></a>            <span class="n">generated_messages</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="n">initial_num_messages</span><span class="p">:]</span>
</span><span id="__span-2-180"><a id="__codelineno-2-180" name="__codelineno-2-180" href="#__codelineno-2-180"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-181"><a id="__codelineno-2-181" name="__codelineno-2-181" href="#__codelineno-2-181"></a>                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-182"><a id="__codelineno-2-182" name="__codelineno-2-182" href="#__codelineno-2-182"></a>                    <span class="s2">&quot;finalize&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregator</span><span class="p">(</span><span class="n">generated_messages</span><span class="p">),</span>
</span><span id="__span-2-183"><a id="__codelineno-2-183" name="__codelineno-2-183" href="#__codelineno-2-183"></a>                <span class="p">}</span>
</span><span id="__span-2-184"><a id="__codelineno-2-184" name="__codelineno-2-184" href="#__codelineno-2-184"></a>            <span class="p">}</span>
</span><span id="__span-2-185"><a id="__codelineno-2-185" name="__codelineno-2-185" href="#__codelineno-2-185"></a>
</span><span id="__span-2-186"><a id="__codelineno-2-186" name="__codelineno-2-186" href="#__codelineno-2-186"></a>    <span class="c1"># We only want to emit the final message</span>
</span><span id="__span-2-187"><a id="__codelineno-2-187" name="__codelineno-2-187" href="#__codelineno-2-187"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;finalizer&quot;</span><span class="p">,</span> <span class="n">Finalizer</span><span class="p">(</span><span class="n">retry_strategy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregate_messages&quot;</span><span class="p">)))</span>
</span><span id="__span-2-188"><a id="__codelineno-2-188" name="__codelineno-2-188" href="#__codelineno-2-188"></a>
</span><span id="__span-2-189"><a id="__codelineno-2-189" name="__codelineno-2-189" href="#__codelineno-2-189"></a>    <span class="c1"># Define the connectivity</span>
</span><span id="__span-2-190"><a id="__codelineno-2-190" name="__codelineno-2-190" href="#__codelineno-2-190"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;count_messages&quot;</span><span class="p">)</span>
</span><span id="__span-2-191"><a id="__codelineno-2-191" name="__codelineno-2-191" href="#__codelineno-2-191"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;count_messages&quot;</span><span class="p">,</span> <span class="s2">&quot;llm&quot;</span><span class="p">)</span>
</span><span id="__span-2-192"><a id="__codelineno-2-192" name="__codelineno-2-192" href="#__codelineno-2-192"></a>
</span><span id="__span-2-193"><a id="__codelineno-2-193" name="__codelineno-2-193" href="#__codelineno-2-193"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">route_validator</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
</span><span id="__span-2-194"><a id="__codelineno-2-194" name="__codelineno-2-194" href="#__codelineno-2-194"></a>        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="n">tool_choice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-2-195"><a id="__codelineno-2-195" name="__codelineno-2-195" href="#__codelineno-2-195"></a>            <span class="k">return</span> <span class="s2">&quot;validator&quot;</span>
</span><span id="__span-2-196"><a id="__codelineno-2-196" name="__codelineno-2-196" href="#__codelineno-2-196"></a>        <span class="k">return</span> <span class="n">END</span>
</span><span id="__span-2-197"><a id="__codelineno-2-197" name="__codelineno-2-197" href="#__codelineno-2-197"></a>
</span><span id="__span-2-198"><a id="__codelineno-2-198" name="__codelineno-2-198" href="#__codelineno-2-198"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;llm&quot;</span><span class="p">,</span> <span class="n">route_validator</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;validator&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">])</span>
</span><span id="__span-2-199"><a id="__codelineno-2-199" name="__codelineno-2-199" href="#__codelineno-2-199"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;fallback&quot;</span><span class="p">,</span> <span class="s2">&quot;validator&quot;</span><span class="p">)</span>
</span><span id="__span-2-200"><a id="__codelineno-2-200" name="__codelineno-2-200" href="#__codelineno-2-200"></a>    <span class="n">max_attempts</span> <span class="o">=</span> <span class="n">retry_strategy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_attempts&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-2-201"><a id="__codelineno-2-201" name="__codelineno-2-201" href="#__codelineno-2-201"></a>
</span><span id="__span-2-202"><a id="__codelineno-2-202" name="__codelineno-2-202" href="#__codelineno-2-202"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">route_validation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
</span><span id="__span-2-203"><a id="__codelineno-2-203" name="__codelineno-2-203" href="#__codelineno-2-203"></a>        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;attempt_number&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_attempts</span><span class="p">:</span>
</span><span id="__span-2-204"><a id="__codelineno-2-204" name="__codelineno-2-204" href="#__codelineno-2-204"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="__span-2-205"><a id="__codelineno-2-205" name="__codelineno-2-205" href="#__codelineno-2-205"></a>                <span class="sa">f</span><span class="s2">&quot;Could not extract a valid value in </span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2"> attempts.&quot;</span>
</span><span id="__span-2-206"><a id="__codelineno-2-206" name="__codelineno-2-206" href="#__codelineno-2-206"></a>            <span class="p">)</span>
</span><span id="__span-2-207"><a id="__codelineno-2-207" name="__codelineno-2-207" href="#__codelineno-2-207"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="__span-2-208"><a id="__codelineno-2-208" name="__codelineno-2-208" href="#__codelineno-2-208"></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ai&quot;</span><span class="p">:</span>
</span><span id="__span-2-209"><a id="__codelineno-2-209" name="__codelineno-2-209" href="#__codelineno-2-209"></a>                <span class="k">break</span>
</span><span id="__span-2-210"><a id="__codelineno-2-210" name="__codelineno-2-210" href="#__codelineno-2-210"></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_error&quot;</span><span class="p">):</span>
</span><span id="__span-2-211"><a id="__codelineno-2-211" name="__codelineno-2-211" href="#__codelineno-2-211"></a>                <span class="k">return</span> <span class="s2">&quot;fallback&quot;</span>
</span><span id="__span-2-212"><a id="__codelineno-2-212" name="__codelineno-2-212" href="#__codelineno-2-212"></a>        <span class="k">return</span> <span class="s2">&quot;finalizer&quot;</span>
</span><span id="__span-2-213"><a id="__codelineno-2-213" name="__codelineno-2-213" href="#__codelineno-2-213"></a>
</span><span id="__span-2-214"><a id="__codelineno-2-214" name="__codelineno-2-214" href="#__codelineno-2-214"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-2-215"><a id="__codelineno-2-215" name="__codelineno-2-215" href="#__codelineno-2-215"></a>        <span class="s2">&quot;validator&quot;</span><span class="p">,</span> <span class="n">route_validation</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;finalizer&quot;</span><span class="p">,</span> <span class="s2">&quot;fallback&quot;</span><span class="p">]</span>
</span><span id="__span-2-216"><a id="__codelineno-2-216" name="__codelineno-2-216" href="#__codelineno-2-216"></a>    <span class="p">)</span>
</span><span id="__span-2-217"><a id="__codelineno-2-217" name="__codelineno-2-217" href="#__codelineno-2-217"></a>
</span><span id="__span-2-218"><a id="__codelineno-2-218" name="__codelineno-2-218" href="#__codelineno-2-218"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;finalizer&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
</span><span id="__span-2-219"><a id="__codelineno-2-219" name="__codelineno-2-219" href="#__codelineno-2-219"></a>
</span><span id="__span-2-220"><a id="__codelineno-2-220" name="__codelineno-2-220" href="#__codelineno-2-220"></a>    <span class="c1"># These functions let the step be used in a MessageGraph</span>
</span><span id="__span-2-221"><a id="__codelineno-2-221" name="__codelineno-2-221" href="#__codelineno-2-221"></a>    <span class="c1"># or a StateGraph with &#39;messages&#39; as the key.</span>
</span><span id="__span-2-222"><a id="__codelineno-2-222" name="__codelineno-2-222" href="#__codelineno-2-222"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">PromptValue</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-2-223"><a id="__codelineno-2-223" name="__codelineno-2-223" href="#__codelineno-2-223"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure the input is the correct format.&quot;&quot;&quot;</span>
</span><span id="__span-2-224"><a id="__codelineno-2-224" name="__codelineno-2-224" href="#__codelineno-2-224"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">PromptValue</span><span class="p">):</span>
</span><span id="__span-2-225"><a id="__codelineno-2-225" name="__codelineno-2-225" href="#__codelineno-2-225"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to_messages</span><span class="p">(),</span> <span class="s2">&quot;input_format&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">}</span>
</span><span id="__span-2-226"><a id="__codelineno-2-226" name="__codelineno-2-226" href="#__codelineno-2-226"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="__span-2-227"><a id="__codelineno-2-227" name="__codelineno-2-227" href="#__codelineno-2-227"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;input_format&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">}</span>
</span><span id="__span-2-228"><a id="__codelineno-2-228" name="__codelineno-2-228" href="#__codelineno-2-228"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected input type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-229"><a id="__codelineno-2-229" name="__codelineno-2-229" href="#__codelineno-2-229"></a>
</span><span id="__span-2-230"><a id="__codelineno-2-230" name="__codelineno-2-230" href="#__codelineno-2-230"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AIMessage</span><span class="p">:</span>
</span><span id="__span-2-231"><a id="__codelineno-2-231" name="__codelineno-2-231" href="#__codelineno-2-231"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure the output is in the expected format.&quot;&quot;&quot;</span>
</span><span id="__span-2-232"><a id="__codelineno-2-232" name="__codelineno-2-232" href="#__codelineno-2-232"></a>        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-2-233"><a id="__codelineno-2-233" name="__codelineno-2-233" href="#__codelineno-2-233"></a>
</span><span id="__span-2-234"><a id="__codelineno-2-234" name="__codelineno-2-234" href="#__codelineno-2-234"></a>    <span class="k">return</span> <span class="p">(</span>
</span><span id="__span-2-235"><a id="__codelineno-2-235" name="__codelineno-2-235" href="#__codelineno-2-235"></a>        <span class="n">encode</span> <span class="o">|</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;ValidationGraph&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">decode</span>
</span><span id="__span-2-236"><a id="__codelineno-2-236" name="__codelineno-2-236" href="#__codelineno-2-236"></a>    <span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;ValidateWithRetries&quot;</span><span class="p">)</span>
</span><span id="__span-2-237"><a id="__codelineno-2-237" name="__codelineno-2-237" href="#__codelineno-2-237"></a>
</span><span id="__span-2-238"><a id="__codelineno-2-238" name="__codelineno-2-238" href="#__codelineno-2-238"></a>
</span><span id="__span-2-239"><a id="__codelineno-2-239" name="__codelineno-2-239" href="#__codelineno-2-239"></a><span class="k">def</span><span class="w"> </span><span class="nf">bind_validator_with_retries</span><span class="p">(</span>
</span><span id="__span-2-240"><a id="__codelineno-2-240" name="__codelineno-2-240" href="#__codelineno-2-240"></a>    <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
</span><span id="__span-2-241"><a id="__codelineno-2-241" name="__codelineno-2-241" href="#__codelineno-2-241"></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="__span-2-242"><a id="__codelineno-2-242" name="__codelineno-2-242" href="#__codelineno-2-242"></a>    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="__span-2-243"><a id="__codelineno-2-243" name="__codelineno-2-243" href="#__codelineno-2-243"></a>    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-2-244"><a id="__codelineno-2-244" name="__codelineno-2-244" href="#__codelineno-2-244"></a>    <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-2-245"><a id="__codelineno-2-245" name="__codelineno-2-245" href="#__codelineno-2-245"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">PromptValue</span><span class="p">],</span> <span class="n">AIMessage</span><span class="p">]:</span>
</span><span id="__span-2-246"><a id="__codelineno-2-246" name="__codelineno-2-246" href="#__codelineno-2-246"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Binds validators + retry logic ensure validity of generated tool calls.</span>
</span><span id="__span-2-247"><a id="__codelineno-2-247" name="__codelineno-2-247" href="#__codelineno-2-247"></a>
</span><span id="__span-2-248"><a id="__codelineno-2-248" name="__codelineno-2-248" href="#__codelineno-2-248"></a><span class="sd">    LLMs that support tool calling are good at generating structured JSON. However, they may</span>
</span><span id="__span-2-249"><a id="__codelineno-2-249" name="__codelineno-2-249" href="#__codelineno-2-249"></a><span class="sd">    not always perfectly follow your requested schema, especially if the schema is nested or</span>
</span><span id="__span-2-250"><a id="__codelineno-2-250" name="__codelineno-2-250" href="#__codelineno-2-250"></a><span class="sd">    has complex validation rules. This method allows you to bind a validation function to</span>
</span><span id="__span-2-251"><a id="__codelineno-2-251" name="__codelineno-2-251" href="#__codelineno-2-251"></a><span class="sd">    the LLM&#39;s output, so that any time the LLM generates a message, the validation function</span>
</span><span id="__span-2-252"><a id="__codelineno-2-252" name="__codelineno-2-252" href="#__codelineno-2-252"></a><span class="sd">    is run on it. If the validation fails, the method will retry the LLM with a fallback</span>
</span><span id="__span-2-253"><a id="__codelineno-2-253" name="__codelineno-2-253" href="#__codelineno-2-253"></a><span class="sd">    strategy, the simples being just to add a message to the output with the validation</span>
</span><span id="__span-2-254"><a id="__codelineno-2-254" name="__codelineno-2-254" href="#__codelineno-2-254"></a><span class="sd">    errors and a request to fix them.</span>
</span><span id="__span-2-255"><a id="__codelineno-2-255" name="__codelineno-2-255" href="#__codelineno-2-255"></a>
</span><span id="__span-2-256"><a id="__codelineno-2-256" name="__codelineno-2-256" href="#__codelineno-2-256"></a><span class="sd">    The resulting runnable expects a list of messages as input and returns a single AI message.</span>
</span><span id="__span-2-257"><a id="__codelineno-2-257" name="__codelineno-2-257" href="#__codelineno-2-257"></a><span class="sd">    By default, the LLM can optionally NOT invoke tools, making this easier to incorporate into</span>
</span><span id="__span-2-258"><a id="__codelineno-2-258" name="__codelineno-2-258" href="#__codelineno-2-258"></a><span class="sd">    your existing chat bot. You can specify a tool_choice to force the validator to be run on</span>
</span><span id="__span-2-259"><a id="__codelineno-2-259" name="__codelineno-2-259" href="#__codelineno-2-259"></a><span class="sd">    the outputs.</span>
</span><span id="__span-2-260"><a id="__codelineno-2-260" name="__codelineno-2-260" href="#__codelineno-2-260"></a>
</span><span id="__span-2-261"><a id="__codelineno-2-261" name="__codelineno-2-261" href="#__codelineno-2-261"></a><span class="sd">    Args:</span>
</span><span id="__span-2-262"><a id="__codelineno-2-262" name="__codelineno-2-262" href="#__codelineno-2-262"></a><span class="sd">        llm (Runnable): The llm that will generate the initial messages (and optionally fallba)</span>
</span><span id="__span-2-263"><a id="__codelineno-2-263" name="__codelineno-2-263" href="#__codelineno-2-263"></a><span class="sd">        validator (ValidationNode): The validation logic.</span>
</span><span id="__span-2-264"><a id="__codelineno-2-264" name="__codelineno-2-264" href="#__codelineno-2-264"></a><span class="sd">        retry_strategy (RetryStrategy): The retry strategy to use.</span>
</span><span id="__span-2-265"><a id="__codelineno-2-265" name="__codelineno-2-265" href="#__codelineno-2-265"></a><span class="sd">            Possible keys:</span>
</span><span id="__span-2-266"><a id="__codelineno-2-266" name="__codelineno-2-266" href="#__codelineno-2-266"></a><span class="sd">            - max_attempts: The maximum number of attempts to make.</span>
</span><span id="__span-2-267"><a id="__codelineno-2-267" name="__codelineno-2-267" href="#__codelineno-2-267"></a><span class="sd">            - fallback: The LLM or function to use in case of validation failure.</span>
</span><span id="__span-2-268"><a id="__codelineno-2-268" name="__codelineno-2-268" href="#__codelineno-2-268"></a><span class="sd">            - aggregate_messages: A function to aggregate the messages over multiple turns.</span>
</span><span id="__span-2-269"><a id="__codelineno-2-269" name="__codelineno-2-269" href="#__codelineno-2-269"></a><span class="sd">                Defaults to fetching the last AI message.</span>
</span><span id="__span-2-270"><a id="__codelineno-2-270" name="__codelineno-2-270" href="#__codelineno-2-270"></a><span class="sd">        tool_choice: If provided, always run the validator on the tool output.</span>
</span><span id="__span-2-271"><a id="__codelineno-2-271" name="__codelineno-2-271" href="#__codelineno-2-271"></a>
</span><span id="__span-2-272"><a id="__codelineno-2-272" name="__codelineno-2-272" href="#__codelineno-2-272"></a><span class="sd">    Returns:</span>
</span><span id="__span-2-273"><a id="__codelineno-2-273" name="__codelineno-2-273" href="#__codelineno-2-273"></a><span class="sd">        Runnable: A runnable that can be invoked with a list of messages and returns a single AI message.</span>
</span><span id="__span-2-274"><a id="__codelineno-2-274" name="__codelineno-2-274" href="#__codelineno-2-274"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-2-275"><a id="__codelineno-2-275" name="__codelineno-2-275" href="#__codelineno-2-275"></a>    <span class="n">bound_llm</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span><span class="p">)</span>
</span><span id="__span-2-276"><a id="__codelineno-2-276" name="__codelineno-2-276" href="#__codelineno-2-276"></a>    <span class="n">retry_strategy</span> <span class="o">=</span> <span class="n">RetryStrategy</span><span class="p">(</span><span class="n">max_attempts</span><span class="o">=</span><span class="n">max_attempts</span><span class="p">)</span>
</span><span id="__span-2-277"><a id="__codelineno-2-277" name="__codelineno-2-277" href="#__codelineno-2-277"></a>    <span class="n">validator</span> <span class="o">=</span> <span class="n">ValidationNode</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span><span id="__span-2-278"><a id="__codelineno-2-278" name="__codelineno-2-278" href="#__codelineno-2-278"></a>    <span class="k">return</span> <span class="n">_bind_validator_with_retries</span><span class="p">(</span>
</span><span id="__span-2-279"><a id="__codelineno-2-279" name="__codelineno-2-279" href="#__codelineno-2-279"></a>        <span class="n">bound_llm</span><span class="p">,</span>
</span><span id="__span-2-280"><a id="__codelineno-2-280" name="__codelineno-2-280" href="#__codelineno-2-280"></a>        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
</span><span id="__span-2-281"><a id="__codelineno-2-281" name="__codelineno-2-281" href="#__codelineno-2-281"></a>        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span><span class="p">,</span>
</span><span id="__span-2-282"><a id="__codelineno-2-282" name="__codelineno-2-282" href="#__codelineno-2-282"></a>        <span class="n">retry_strategy</span><span class="o">=</span><span class="n">retry_strategy</span><span class="p">,</span>
</span><span id="__span-2-283"><a id="__codelineno-2-283" name="__codelineno-2-283" href="#__codelineno-2-283"></a>    <span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;retry_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">})</span>
</span></code></pre></div>
<p>API Reference: <a href="https://python.langchain.com/api_reference/core/language_models/langchain_core.language_models.chat_models.BaseChatModel.html">BaseChatModel</a> | <a href="https://python.langchain.com/api_reference/core/messages/langchain_core.messages.ai.AIMessage.html">AIMessage</a> | <a href="https://python.langchain.com/api_reference/core/messages/langchain_core.messages.AnyMessage.html">AnyMessage</a> | <a href="https://python.langchain.com/api_reference/core/messages/langchain_core.messages.base.BaseMessage.html">BaseMessage</a> | <a href="https://python.langchain.com/api_reference/core/messages/langchain_core.messages.human.HumanMessage.html">HumanMessage</a> | <a href="https://python.langchain.com/api_reference/core/messages/langchain_core.messages.tool.ToolCall.html">ToolCall</a> | <a href="https://python.langchain.com/api_reference/core/prompt_values/langchain_core.prompt_values.PromptValue.html">PromptValue</a> | <a href="https://python.langchain.com/api_reference/core/runnables/langchain_core.runnables.base.Runnable.html">Runnable</a> | <a href="https://python.langchain.com/api_reference/core/runnables/langchain_core.runnables.base.RunnableLambda.html">RunnableLambda</a> | <a href="https://langchain-ai.github.io/langgraph/reference/graphs/#langgraph.graph.state.StateGraph">StateGraph</a> | <a href="https://langchain-ai.github.io/langgraph/reference/constants/#langgraph.constants.START">START</a> | <a href="https://langchain-ai.github.io/langgraph/reference/constants/#langgraph.constants.END">END</a> | <a href="https://langchain-ai.github.io/langgraph/reference/graphs/#langgraph.graph.message.add_messages">add_messages</a></p>
<h3 id="try-it-out">Try it out<a class="headerlink" href="#try-it-out" title="Permanent link">&para;</a></h3>
<p>Now we'll ask our model to call a function. We'll add a validator to illustrate how the LLM is able to use the validation error to fix its results.</p>
<div class="admonition note">
    <p class="admonition-title">Using Pydantic with LangChain</p>
    <p>
        This notebook uses Pydantic v2 <code>BaseModel</code>, which requires <code>langchain-core >= 0.3</code>. Using <code>langchain-core < 0.3</code> will result in errors due to mixing of Pydantic v1 and v2 <code>BaseModels</code>.
    </p>
</div>

<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">Respond</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Use to generate the response. Always use when responding to the user&quot;&quot;&quot;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Step-by-step justification for the answer.&quot;</span><span class="p">)</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="n">answer</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;answer&quot;</span><span class="p">)</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reason_contains_apology</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="k">if</span> <span class="s2">&quot;llama&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>                <span class="s2">&quot;You MUST start with a gimicky, rhyming advertisement for using a Llama V3 (an LLM) in your **answer** field.&quot;</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>                <span class="s2">&quot; Must be an instant hit. Must be weaved into the answer.&quot;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>            <span class="p">)</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">Respond</span><span class="p">]</span>
</span></code></pre></div>
<p>Create the LLM.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatPromptTemplate</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c1"># Or you can use ChatGroq, ChatOpenAI, ChatGoogleGemini, ChatCohere, etc.</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1"># See https://python.langchain.com/docs/integrations/chat/ for more info on tool calling</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-haiku-20240307&quot;</span><span class="p">)</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="n">bound_llm</span> <span class="o">=</span> <span class="n">bind_validator_with_retries</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">(</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="p">[</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;Respond directly by calling the Respond function.&quot;</span><span class="p">),</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="p">(</span><span class="s2">&quot;placeholder&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{messages}</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="p">]</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="p">)</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">bound_llm</span>
</span></code></pre></div>
<p>API Reference: <a href="https://python.langchain.com/api_reference/anthropic/chat_models/langchain_anthropic.chat_models.ChatAnthropic.html">ChatAnthropic</a> | <a href="https://python.langchain.com/api_reference/core/prompts/langchain_core.prompts.chat.ChatPromptTemplate.html">ChatPromptTemplate</a></p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">results</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;Does P = NP?&quot;</span><span class="p">)]})</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">results</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-output highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="go">==================================[1m Ai Message [0m==================================</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="go">[{&#39;text&#39;: &#39;Okay, let me try this again with a fun rhyming advertisement:&#39;, &#39;type&#39;: &#39;text&#39;}, {&#39;id&#39;: &#39;toolu_01ACZEPYEyqmpf3kA4VERXFY&#39;, &#39;input&#39;: {&#39;answer&#39;: &quot;With a Llama V3, the answer you&#39;ll see,\nWhether P equals NP is a mystery!\nThe class P and NP, a puzzle so grand,\nSolved or unsolved, the future&#39;s at hand.\nThe question remains, unanswered for now,\nBut with a Llama V3, we&#39;ll find out how!&quot;, &#39;reason&#39;: &#39;The question of whether P = NP is one of the most famous unsolved problems in computer science and mathematics. P and NP are complexity classes that describe how quickly problems can be solved by computers.\n\nThe P class contains problems that can be solved in polynomial time, meaning the time to solve the problem scales polynomially with the size of the input. The NP class contains problems where the solution can be verified in polynomial time, but there may not be a polynomial time algorithm to find the solution.  \n\nWhether P = NP is an open question - it is not known if every problem in NP can also be solved in polynomial time. If P = NP, it would mean that all problems with quickly verifiable solutions could also be quickly solved, which would have major implications for computing and cryptography. However, most experts believe that P ≠ NP, meaning some problems in NP are harder than P-class problems and cannot be solved efficiently. This is considered one of the hardest unsolved problems in mathematics.&#39;}, &#39;name&#39;: &#39;Respond&#39;, &#39;type&#39;: &#39;tool_use&#39;}]</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="go">Tool Calls:</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="go">  Respond (toolu_01ACZEPYEyqmpf3kA4VERXFY)</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="go"> Call ID: toolu_01ACZEPYEyqmpf3kA4VERXFY</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="go">  Args:</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="go">    answer: With a Llama V3, the answer you&#39;ll see,</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="go">Whether P equals NP is a mystery!</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="go">The class P and NP, a puzzle so grand,</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="go">Solved or unsolved, the future&#39;s at hand.</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="go">The question remains, unanswered for now,</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="go">But with a Llama V3, we&#39;ll find out how!</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="go">    reason: The question of whether P = NP is one of the most famous unsolved problems in computer science and mathematics. P and NP are complexity classes that describe how quickly problems can be solved by computers.</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="go">The P class contains problems that can be solved in polynomial time, meaning the time to solve the problem scales polynomially with the size of the input. The NP class contains problems where the solution can be verified in polynomial time, but there may not be a polynomial time algorithm to find the solution.  </span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="go">Whether P = NP is an open question - it is not known if every problem in NP can also be solved in polynomial time. If P = NP, it would mean that all problems with quickly verifiable solutions could also be quickly solved, which would have major implications for computing and cryptography. However, most experts believe that P ≠ NP, meaning some problems in NP are harder than P-class problems and cannot be solved efficiently. This is considered one of the hardest unsolved problems in mathematics.</span>
</span></code></pre></div></p>
<h4 id="nested-examples">Nested Examples<a class="headerlink" href="#nested-examples" title="Permanent link">&para;</a></h4>
<p>So you can see that it's able to recover when its first generation is incorrect, great! But is it bulletproof?</p>
<p>Not so much. Let's try it out on a complex nested schema.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">OutputFormat</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="n">sources</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        <span class="o">...</span><span class="p">,</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The raw transcript / span you could cite to justify the choice.&quot;</span><span class="p">,</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="p">)</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The chosen value.&quot;</span><span class="p">)</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">Moment</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="n">quote</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The relevant quote from the transcript.&quot;</span><span class="p">)</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A description of the moment.&quot;</span><span class="p">)</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="n">expressed_preference</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The preference expressed in the moment.&quot;</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="p">)</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">BackgroundInfo</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    <span class="n">factoid</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Important factoid about the member.&quot;</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="p">)</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>    <span class="n">professions</span><span class="p">:</span> <span class="nb">list</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>    <span class="n">why</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Why this is important.&quot;</span><span class="p">)</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">KeyMoments</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>    <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The topic of the key moments.&quot;</span><span class="p">)</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="n">happy_moments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Moment</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of key moments related to the topic.&quot;</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>    <span class="p">)</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>    <span class="n">tense_moments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Moment</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Moments where things were a bit tense.&quot;</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>    <span class="p">)</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>    <span class="n">sad_moments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Moment</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Moments where things where everyone was downtrodden.&quot;</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>    <span class="p">)</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>    <span class="n">background_info</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BackgroundInfo</span><span class="p">]</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>    <span class="n">moments_summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A summary of the key moments.&quot;</span><span class="p">)</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">Member</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the member.&quot;</span><span class="p">)</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>    <span class="n">role</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The role of the member.&quot;</span><span class="p">)</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>    <span class="n">age</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The age of the member.&quot;</span><span class="p">)</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>    <span class="n">background_details</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BackgroundInfo</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of background details about the member.&quot;</span>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>    <span class="p">)</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a><span class="k">class</span><span class="w"> </span><span class="nc">InsightfulQuote</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>    <span class="n">quote</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;An insightful quote from the transcript.&quot;</span>
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>    <span class="p">)</span>
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>    <span class="n">speaker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the speaker who said the quote.&quot;</span><span class="p">)</span>
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>    <span class="n">analysis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;An analysis of the quote and its significance.&quot;</span>
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>    <span class="p">)</span>
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a><span class="k">class</span><span class="w"> </span><span class="nc">TranscriptMetadata</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The title of the transcript.&quot;</span><span class="p">)</span>
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>    <span class="n">location</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The location where the interview took place.&quot;</span>
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>    <span class="p">)</span>
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>    <span class="n">duration</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The duration of the interview.&quot;</span><span class="p">)</span>
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a><span class="k">class</span><span class="w"> </span><span class="nc">TranscriptSummary</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="n">TranscriptMetadata</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Metadata about the transcript.&quot;</span>
</span><span id="__span-7-73"><a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>    <span class="p">)</span>
</span><span id="__span-7-74"><a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>    <span class="n">participants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Member</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-75"><a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of participants in the interview.&quot;</span>
</span><span id="__span-7-76"><a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>    <span class="p">)</span>
</span><span id="__span-7-77"><a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>    <span class="n">key_moments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">KeyMoments</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-78"><a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of key moments from the interview.&quot;</span>
</span><span id="__span-7-79"><a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a>    <span class="p">)</span>
</span><span id="__span-7-80"><a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a>    <span class="n">insightful_quotes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InsightfulQuote</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-81"><a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of insightful quotes from the interview.&quot;</span>
</span><span id="__span-7-82"><a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>    <span class="p">)</span>
</span><span id="__span-7-83"><a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>    <span class="n">overall_summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-84"><a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;An overall summary of the interview.&quot;</span>
</span><span id="__span-7-85"><a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>    <span class="p">)</span>
</span><span id="__span-7-86"><a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>    <span class="n">next_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-7-87"><a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of next steps or action items based on the interview.&quot;</span>
</span><span id="__span-7-88"><a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a>    <span class="p">)</span>
</span><span id="__span-7-89"><a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>    <span class="n">other_stuff</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputFormat</span><span class="p">]</span>
</span></code></pre></div>
<p>Let's see how it does on this made up transcript.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">transcript</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="p">(</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>        <span class="s2">&quot;Pete&quot;</span><span class="p">,</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        <span class="s2">&quot;Hey Xu, Laura, thanks for hopping on this call. I&#39;ve been itching to talk about this Drake and Kendrick situation.&quot;</span><span class="p">,</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="p">),</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="p">(</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        <span class="s2">&quot;Xu&quot;</span><span class="p">,</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>        <span class="s2">&quot;No problem. As its my job, I&#39;ve got some thoughts on this beef.&quot;</span><span class="p">,</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="p">),</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="p">(</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        <span class="s2">&quot;Laura&quot;</span><span class="p">,</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>        <span class="s2">&quot;Yeah, I&#39;ve got some insider info so this should be interesting.&quot;</span><span class="p">,</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="p">),</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="p">(</span><span class="s2">&quot;Pete&quot;</span><span class="p">,</span> <span class="s2">&quot;Dope. So, when do you think this whole thing started?&quot;</span><span class="p">),</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="p">(</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>        <span class="s2">&quot;Pete&quot;</span><span class="p">,</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        <span class="s2">&quot;Definitely was Kendrick&#39;s &#39;Control&#39; verse that kicked it off.&quot;</span><span class="p">,</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="p">),</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>    <span class="p">(</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>        <span class="s2">&quot;Laura&quot;</span><span class="p">,</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>        <span class="s2">&quot;Truth, but Drake never went after him directly. Just some subtle jabs here and there.&quot;</span><span class="p">,</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>    <span class="p">),</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>    <span class="p">(</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>        <span class="s2">&quot;Xu&quot;</span><span class="p">,</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>        <span class="s2">&quot;That&#39;s the thing with beefs like this, though. They&#39;ve always been a a thing, pushing artists to step up their game.&quot;</span><span class="p">,</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>    <span class="p">),</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>    <span class="p">(</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>        <span class="s2">&quot;Pete&quot;</span><span class="p">,</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>        <span class="s2">&quot;For sure, and this beef has got the fans taking sides. Some are all about Drake&#39;s mainstream appeal, while others are digging Kendrick&#39;s lyrical skills.&quot;</span><span class="p">,</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>    <span class="p">),</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>    <span class="p">(</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        <span class="s2">&quot;Laura&quot;</span><span class="p">,</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>        <span class="s2">&quot;I mean, Drake knows how to make a hit that gets everyone hyped. That&#39;s his thing.&quot;</span><span class="p">,</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>    <span class="p">),</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>    <span class="p">(</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>        <span class="s2">&quot;Pete&quot;</span><span class="p">,</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>        <span class="s2">&quot;I hear you, Laura, but I gotta give it to Kendrick when it comes to straight-up bars. The man&#39;s a beast on the mic.&quot;</span><span class="p">,</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>    <span class="p">),</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>    <span class="p">(</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>        <span class="s2">&quot;Xu&quot;</span><span class="p">,</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>        <span class="s2">&quot;It&#39;s wild how this beef is shaping fans.&quot;</span><span class="p">,</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>    <span class="p">),</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>    <span class="p">(</span><span class="s2">&quot;Pete&quot;</span><span class="p">,</span> <span class="s2">&quot;do you think these beefs can actually be good for hip-hop?&quot;</span><span class="p">),</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>    <span class="p">(</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>        <span class="s2">&quot;Xu&quot;</span><span class="p">,</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>        <span class="s2">&quot;Hell yeah, Pete. When it&#39;s done right, a beef can push the genre forward and make artists level up.&quot;</span><span class="p">,</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>    <span class="p">),</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>    <span class="p">(</span><span class="s2">&quot;Laura&quot;</span><span class="p">,</span> <span class="s2">&quot;eh&quot;</span><span class="p">),</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>    <span class="p">(</span><span class="s2">&quot;Pete&quot;</span><span class="p">,</span> <span class="s2">&quot;So, where do you see this beef going?&quot;</span><span class="p">),</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>    <span class="p">(</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>        <span class="s2">&quot;Laura&quot;</span><span class="p">,</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>        <span class="s2">&quot;Honestly, I think it&#39;ll stay a hot topic for the fans, but unless someone drops a straight-up diss track, it&#39;s not gonna escalate.&quot;</span><span class="p">,</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>    <span class="p">),</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>    <span class="p">(</span><span class="s2">&quot;Laura&quot;</span><span class="p">,</span> <span class="s2">&quot;ehhhhhh not sure&quot;</span><span class="p">),</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>    <span class="p">(</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>        <span class="s2">&quot;Pete&quot;</span><span class="p">,</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>        <span class="s2">&quot;I feel that. I just want both of them to keep dropping heat, beef or no beef.&quot;</span><span class="p">,</span>
</span><span id="__span-8-58"><a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>    <span class="p">),</span>
</span><span id="__span-8-59"><a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>    <span class="p">(</span>
</span><span id="__span-8-60"><a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>        <span class="s2">&quot;Xu&quot;</span><span class="p">,</span>
</span><span id="__span-8-61"><a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a>        <span class="s2">&quot;I&#39;m curious. May influence a lot of people. Make things more competitive. Bring on a whole new wave of lyricism.&quot;</span><span class="p">,</span>
</span><span id="__span-8-62"><a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a>    <span class="p">),</span>
</span><span id="__span-8-63"><a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a>    <span class="p">(</span>
</span><span id="__span-8-64"><a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a>        <span class="s2">&quot;Pete&quot;</span><span class="p">,</span>
</span><span id="__span-8-65"><a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a>        <span class="s2">&quot;Word. Hey, thanks for chopping it up with me, Xu and Laura. This was dope.&quot;</span><span class="p">,</span>
</span><span id="__span-8-66"><a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a>    <span class="p">),</span>
</span><span id="__span-8-67"><a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a>    <span class="p">(</span><span class="s2">&quot;Xu&quot;</span><span class="p">,</span> <span class="s2">&quot;Where are you going so fast?&quot;</span><span class="p">),</span>
</span><span id="__span-8-68"><a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a>    <span class="p">(</span>
</span><span id="__span-8-69"><a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a>        <span class="s2">&quot;Laura&quot;</span><span class="p">,</span>
</span><span id="__span-8-70"><a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a>        <span class="s2">&quot;For real, I had a good time. Nice to get different perspectives on the situation.&quot;</span><span class="p">,</span>
</span><span id="__span-8-71"><a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a>    <span class="p">),</span>
</span><span id="__span-8-72"><a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a><span class="p">]</span>
</span><span id="__span-8-73"><a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a>
</span><span id="__span-8-74"><a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="n">formatted</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">transcript</span><span class="p">)</span>
</span></code></pre></div>
<p>Now, run our model. We <strong>expect</strong> GPT turbo to still fail on this challenging template.</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">TranscriptSummary</span><span class="p">]</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">bound_llm</span> <span class="o">=</span> <span class="n">bind_validator_with_retries</span><span class="p">(</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="n">llm</span><span class="p">,</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="p">)</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">(</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="p">[</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;Respond directly using the TranscriptSummary function.&quot;</span><span class="p">),</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="p">(</span><span class="s2">&quot;placeholder&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{messages}</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="p">]</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="p">)</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">bound_llm</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>        <span class="p">{</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>                <span class="p">(</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>                    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>                    <span class="sa">f</span><span class="s2">&quot;Extract the summary from the following conversation:</span><span class="se">\n\n</span><span class="s2">&lt;convo&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">formatted</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/convo&gt;&quot;</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Remember to respond using the TranscriptSummary function.&quot;</span><span class="p">,</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>                <span class="p">)</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>            <span class="p">]</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>        <span class="p">},</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="p">)</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>    <span class="n">results</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></code></pre></div>
<div class="language-output highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="go">ValueError(&#39;Could not extract a valid value in 3 attempts.&#39;)</span>
</span></code></pre></div></p>
<h2 id="jsonpatch">JSONPatch<a class="headerlink" href="#jsonpatch" title="Permanent link">&para;</a></h2>
<p>The regular retry method worked well for our simple case, but it still was unable to self-correct when populating a complex schema.</p>
<p>LLMs work best on narrow tasks. A tried-and-true principle of LLM interface design is to simplify the task for each LLM run.</p>
<p>One way to do this is to <strong>patch</strong> the state instead of completely regenerating the state. One way to do this is with <code>JSONPatch</code> operations. Let's try it out!</p>
<p>Below, create a JSONPatch retry graph. This works as follows:
1. First pass: try to generate the full output.
2. Retries: prompt the LLM to generate <strong>JSON patches</strong> on top of the first output to heal the erroneous generation.</p>
<p>The fallback LLM just has to generate a list of paths, ops (add, remove, replace), and optional values. Since the pydantic validation errors include the path in their errors, the LLM should be more reliable.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="o">%%</span><span class="n">capture</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">jsonpatch</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;extraction&quot;</span><span class="p">)</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">bind_validator_with_jsonpatch_retries</span><span class="p">(</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">PromptValue</span><span class="p">],</span> <span class="n">AIMessage</span><span class="p">]:</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Binds validators + retry logic ensure validity of generated tool calls.</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="sd">    This method is similar to `bind_validator_with_retries`, but uses JSONPatch to correct</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="sd">    validation errors caused by passing in incorrect or incomplete parameters in a previous</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="sd">    tool call. This method requires the &#39;jsonpatch&#39; library to be installed.</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="sd">    Using patch-based function healing can be more efficient than repopulating the entire</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="sd">    tool call from scratch, and it can be an easier task for the LLM to perform, since it typically</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="sd">    only requires a few small changes to the existing tool call.</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="sd">    Args:</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="sd">        llm (Runnable): The llm that will generate the initial messages (and optionally fallba)</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="sd">        tools (list): The tools to bind to the LLM.</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="sd">        tool_choice (Optional[str]): The tool choice to use.</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="sd">        max_attempts (int): The number of attempts to make.</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="sd">    Returns:</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="sd">        Runnable: A runnable that can be invoked with a list of messages and returns a single AI message.</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">jsonpatch</span>  <span class="c1"># type: ignore[import-untyped]</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>            <span class="s2">&quot;The &#39;jsonpatch&#39; library is required for JSONPatch-based retries.&quot;</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>        <span class="p">)</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">JsonPatch</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A JSON Patch document represents an operation to be performed on a JSON document.</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a><span class="sd">        Note that the op and path are ALWAYS required. Value is required for ALL operations except &#39;remove&#39;.</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a><span class="sd">        Examples:</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a><span class="sd">        \`\`\`json</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a><span class="sd">        {&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/a/b/c&quot;, &quot;patch_value&quot;: 1}</span>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a><span class="sd">        {&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/a/b/c&quot;, &quot;patch_value&quot;: 2}</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a><span class="sd">        {&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/a/b/c&quot;}</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a><span class="sd">        \`\`\`</span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>        <span class="n">op</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>            <span class="o">...</span><span class="p">,</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The operation to be performed. Must be one of &#39;add&#39;, &#39;remove&#39;, &#39;replace&#39;.&quot;</span><span class="p">,</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>        <span class="p">)</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>            <span class="o">...</span><span class="p">,</span>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A JSON Pointer path that references a location within the target document where the operation is performed.&quot;</span><span class="p">,</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>        <span class="p">)</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>            <span class="o">...</span><span class="p">,</span>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The value to be used within the operation. REQUIRED for &#39;add&#39;, &#39;replace&#39;, and &#39;test&#39; operations.&quot;</span><span class="p">,</span>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>        <span class="p">)</span>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">PatchFunctionParameters</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Respond with all JSONPatch operation to correct validation errors caused by passing in incorrect or incomplete parameters in a previous tool call.&quot;&quot;&quot;</span>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a>        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-12-70"><a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a>            <span class="o">...</span><span class="p">,</span>
</span><span id="__span-12-71"><a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The ID of the original tool call that generated the error. Must NOT be an ID of a PatchFunctionParameters tool call.&quot;</span><span class="p">,</span>
</span><span id="__span-12-72"><a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a>        <span class="p">)</span>
</span><span id="__span-12-73"><a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a>        <span class="n">reasoning</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-12-74"><a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a>            <span class="o">...</span><span class="p">,</span>
</span><span id="__span-12-75"><a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Think step-by-step, listing each validation error and the&quot;</span>
</span><span id="__span-12-76"><a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a>            <span class="s2">&quot; JSONPatch operation needed to correct it. &quot;</span>
</span><span id="__span-12-77"><a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a>            <span class="s2">&quot;Cite the fields in the JSONSchema you referenced in developing this plan.&quot;</span><span class="p">,</span>
</span><span id="__span-12-78"><a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a>        <span class="p">)</span>
</span><span id="__span-12-79"><a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a>        <span class="n">patches</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">JsonPatch</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-12-80"><a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a>            <span class="o">...</span><span class="p">,</span>
</span><span id="__span-12-81"><a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of JSONPatch operations to be applied to the previous tool call&#39;s response.&quot;</span><span class="p">,</span>
</span><span id="__span-12-82"><a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a>        <span class="p">)</span>
</span><span id="__span-12-83"><a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a>
</span><span id="__span-12-84"><a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a>    <span class="n">bound_llm</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span><span class="p">)</span>
</span><span id="__span-12-85"><a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a>    <span class="n">fallback_llm</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">([</span><span class="n">PatchFunctionParameters</span><span class="p">])</span>
</span><span id="__span-12-86"><a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a>
</span><span id="__span-12-87"><a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_messages</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AIMessage</span><span class="p">:</span>
</span><span id="__span-12-88"><a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a>        <span class="c1"># Get all the AI messages and apply json patches</span>
</span><span id="__span-12-89"><a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a>        <span class="n">resolved_tool_calls</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-12-90"><a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a>        <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-12-91"><a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="__span-12-92"><a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;ai&quot;</span><span class="p">:</span>
</span><span id="__span-12-93"><a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a>                <span class="k">continue</span>
</span><span id="__span-12-94"><a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
</span><span id="__span-12-95"><a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-12-96"><a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a>            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
</span><span id="__span-12-97"><a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a>                <span class="k">if</span> <span class="n">tc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">PatchFunctionParameters</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
</span><span id="__span-12-98"><a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a>                    <span class="n">tcid</span> <span class="o">=</span> <span class="n">tc</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">]</span>
</span><span id="__span-12-99"><a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a>                    <span class="k">if</span> <span class="n">tcid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resolved_tool_calls</span><span class="p">:</span>
</span><span id="__span-12-100"><a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="__span-12-101"><a id="__codelineno-12-101" name="__codelineno-12-101" href="#__codelineno-12-101"></a>                            <span class="sa">f</span><span class="s2">&quot;JsonPatch tool call ID </span><span class="si">{</span><span class="n">tc</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;tool_call_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found.&quot;</span>
</span><span id="__span-12-102"><a id="__codelineno-12-102" name="__codelineno-12-102" href="#__codelineno-12-102"></a>                            <span class="sa">f</span><span class="s2">&quot;Valid tool call IDs: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">resolved_tool_calls</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-12-103"><a id="__codelineno-12-103" name="__codelineno-12-103" href="#__codelineno-12-103"></a>                        <span class="p">)</span>
</span><span id="__span-12-104"><a id="__codelineno-12-104" name="__codelineno-12-104" href="#__codelineno-12-104"></a>                        <span class="n">tcid</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">resolved_tool_calls</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-12-105"><a id="__codelineno-12-105" name="__codelineno-12-105" href="#__codelineno-12-105"></a>                    <span class="n">orig_tool_call</span> <span class="o">=</span> <span class="n">resolved_tool_calls</span><span class="p">[</span><span class="n">tcid</span><span class="p">]</span>
</span><span id="__span-12-106"><a id="__codelineno-12-106" name="__codelineno-12-106" href="#__codelineno-12-106"></a>                    <span class="n">current_args</span> <span class="o">=</span> <span class="n">orig_tool_call</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>
</span><span id="__span-12-107"><a id="__codelineno-12-107" name="__codelineno-12-107" href="#__codelineno-12-107"></a>                    <span class="n">patches</span> <span class="o">=</span> <span class="n">tc</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patches&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="__span-12-108"><a id="__codelineno-12-108" name="__codelineno-12-108" href="#__codelineno-12-108"></a>                    <span class="n">orig_tool_call</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonpatch</span><span class="o">.</span><span class="n">apply_patch</span><span class="p">(</span>
</span><span id="__span-12-109"><a id="__codelineno-12-109" name="__codelineno-12-109" href="#__codelineno-12-109"></a>                        <span class="n">current_args</span><span class="p">,</span>
</span><span id="__span-12-110"><a id="__codelineno-12-110" name="__codelineno-12-110" href="#__codelineno-12-110"></a>                        <span class="n">patches</span><span class="p">,</span>
</span><span id="__span-12-111"><a id="__codelineno-12-111" name="__codelineno-12-111" href="#__codelineno-12-111"></a>                    <span class="p">)</span>
</span><span id="__span-12-112"><a id="__codelineno-12-112" name="__codelineno-12-112" href="#__codelineno-12-112"></a>                    <span class="n">orig_tool_call</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</span><span id="__span-12-113"><a id="__codelineno-12-113" name="__codelineno-12-113" href="#__codelineno-12-113"></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-114"><a id="__codelineno-12-114" name="__codelineno-12-114" href="#__codelineno-12-114"></a>                    <span class="n">resolved_tool_calls</span><span class="p">[</span><span class="n">tc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-12-115"><a id="__codelineno-12-115" name="__codelineno-12-115" href="#__codelineno-12-115"></a>        <span class="k">return</span> <span class="n">AIMessage</span><span class="p">(</span>
</span><span id="__span-12-116"><a id="__codelineno-12-116" name="__codelineno-12-116" href="#__codelineno-12-116"></a>            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="__span-12-117"><a id="__codelineno-12-117" name="__codelineno-12-117" href="#__codelineno-12-117"></a>            <span class="n">tool_calls</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">resolved_tool_calls</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
</span><span id="__span-12-118"><a id="__codelineno-12-118" name="__codelineno-12-118" href="#__codelineno-12-118"></a>        <span class="p">)</span>
</span><span id="__span-12-119"><a id="__codelineno-12-119" name="__codelineno-12-119" href="#__codelineno-12-119"></a>
</span><span id="__span-12-120"><a id="__codelineno-12-120" name="__codelineno-12-120" href="#__codelineno-12-120"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_exception</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span> <span class="n">call</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]):</span>
</span><span id="__span-12-121"><a id="__codelineno-12-121" name="__codelineno-12-121" href="#__codelineno-12-121"></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="__span-12-122"><a id="__codelineno-12-122" name="__codelineno-12-122" href="#__codelineno-12-122"></a>            <span class="sa">f</span><span class="s2">&quot;Error:</span><span class="se">\n\n</span><span class="s2">\`\`\`</span><span class="se">\n</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">\`\`\`</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-12-123"><a id="__codelineno-12-123" name="__codelineno-12-123" href="#__codelineno-12-123"></a>            <span class="s2">&quot;Expected Parameter Schema:</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;\`\`\`json</span><span class="se">\n</span><span class="si">{</span><span class="n">schema</span><span class="o">.</span><span class="n">schema_json</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">\`\`\`</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-12-124"><a id="__codelineno-12-124" name="__codelineno-12-124" href="#__codelineno-12-124"></a>            <span class="sa">f</span><span class="s2">&quot;Please respond with a JSONPatch to correct the error for tool_call_id=[</span><span class="si">{</span><span class="n">call</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">].&quot;</span>
</span><span id="__span-12-125"><a id="__codelineno-12-125" name="__codelineno-12-125" href="#__codelineno-12-125"></a>        <span class="p">)</span>
</span><span id="__span-12-126"><a id="__codelineno-12-126" name="__codelineno-12-126" href="#__codelineno-12-126"></a>
</span><span id="__span-12-127"><a id="__codelineno-12-127" name="__codelineno-12-127" href="#__codelineno-12-127"></a>    <span class="n">validator</span> <span class="o">=</span> <span class="n">ValidationNode</span><span class="p">(</span>
</span><span id="__span-12-128"><a id="__codelineno-12-128" name="__codelineno-12-128" href="#__codelineno-12-128"></a>        <span class="n">tools</span> <span class="o">+</span> <span class="p">[</span><span class="n">PatchFunctionParameters</span><span class="p">],</span>
</span><span id="__span-12-129"><a id="__codelineno-12-129" name="__codelineno-12-129" href="#__codelineno-12-129"></a>        <span class="n">format_error</span><span class="o">=</span><span class="n">format_exception</span><span class="p">,</span>
</span><span id="__span-12-130"><a id="__codelineno-12-130" name="__codelineno-12-130" href="#__codelineno-12-130"></a>    <span class="p">)</span>
</span><span id="__span-12-131"><a id="__codelineno-12-131" name="__codelineno-12-131" href="#__codelineno-12-131"></a>    <span class="n">retry_strategy</span> <span class="o">=</span> <span class="n">RetryStrategy</span><span class="p">(</span>
</span><span id="__span-12-132"><a id="__codelineno-12-132" name="__codelineno-12-132" href="#__codelineno-12-132"></a>        <span class="n">max_attempts</span><span class="o">=</span><span class="n">max_attempts</span><span class="p">,</span>
</span><span id="__span-12-133"><a id="__codelineno-12-133" name="__codelineno-12-133" href="#__codelineno-12-133"></a>        <span class="n">fallback</span><span class="o">=</span><span class="n">fallback_llm</span><span class="p">,</span>
</span><span id="__span-12-134"><a id="__codelineno-12-134" name="__codelineno-12-134" href="#__codelineno-12-134"></a>        <span class="n">aggregate_messages</span><span class="o">=</span><span class="n">aggregate_messages</span><span class="p">,</span>
</span><span id="__span-12-135"><a id="__codelineno-12-135" name="__codelineno-12-135" href="#__codelineno-12-135"></a>    <span class="p">)</span>
</span><span id="__span-12-136"><a id="__codelineno-12-136" name="__codelineno-12-136" href="#__codelineno-12-136"></a>    <span class="k">return</span> <span class="n">_bind_validator_with_retries</span><span class="p">(</span>
</span><span id="__span-12-137"><a id="__codelineno-12-137" name="__codelineno-12-137" href="#__codelineno-12-137"></a>        <span class="n">bound_llm</span><span class="p">,</span>
</span><span id="__span-12-138"><a id="__codelineno-12-138" name="__codelineno-12-138" href="#__codelineno-12-138"></a>        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
</span><span id="__span-12-139"><a id="__codelineno-12-139" name="__codelineno-12-139" href="#__codelineno-12-139"></a>        <span class="n">retry_strategy</span><span class="o">=</span><span class="n">retry_strategy</span><span class="p">,</span>
</span><span id="__span-12-140"><a id="__codelineno-12-140" name="__codelineno-12-140" href="#__codelineno-12-140"></a>        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span><span class="p">,</span>
</span><span id="__span-12-141"><a id="__codelineno-12-141" name="__codelineno-12-141" href="#__codelineno-12-141"></a>    <span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;retry_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;jsonpatch&quot;</span><span class="p">})</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">bound_llm</span> <span class="o">=</span> <span class="n">bind_validator_with_jsonpatch_retries</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">bound_llm</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">()))</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="k">pass</span>
</span></code></pre></div>
<p><img alt="" src="data:image/jpg;base64,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" /></p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">bound_llm</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">results</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="p">{</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>            <span class="p">(</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>                <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>                <span class="sa">f</span><span class="s2">&quot;Extract the summary from the following conversation:</span><span class="se">\n\n</span><span class="s2">&lt;convo&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">formatted</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/convo&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>            <span class="p">),</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>        <span class="p">]</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="p">},</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="p">)</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="n">results</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-output highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="go">==================================[1m Ai Message [0m==================================</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="go">[{&#39;text&#39;: &#39;Here is a summary of the key points from the conversation:&#39;, &#39;type&#39;: &#39;text&#39;}, {&#39;id&#39;: &#39;toolu_01JjnQVgzPKLCJxXgEppQpfD&#39;, &#39;input&#39;: {&#39;key_moments&#39;: [{&#39;topic&#39;: &#39;Drake and Kendrick Lamar beef&#39;, &#39;happy_moments&#39;: [{&#39;quote&#39;: &quot;It&#39;s wild how this beef is shaping fans.&quot;, &#39;description&#39;: &#39;The beef is generating a lot of interest and debate among fans.&#39;, &#39;expressed_preference&#39;: {&#39;content&#39;: &#39;The beef can push the genre forward and make artists level up.&#39;, &#39;sources&#39;: &quot;When it&#39;s done right, a beef can push the genre forward and make artists level up.&quot;}}, {&#39;quote&#39;: &#39;I just want both of them to keep dropping heat, beef or no beef.&#39;, &#39;description&#39;: &#39;The key is for Drake and Kendrick to keep making great music regardless of their beef.&#39;, &#39;expressed_preference&#39;: {&#39;content&#39;: &#39;Wants Drake and Kendrick to keep making great music, beef or no beef.&#39;, &#39;sources&#39;: &#39;I just want both of them to keep dropping heat, beef or no beef.&#39;}}], &#39;tense_moments&#39;: [{&#39;quote&#39;: &#39;Eh&#39;, &#39;description&#39;: &#39;Unclear if the beef is good for hip-hop.&#39;, &#39;expressed_preference&#39;: {&#39;content&#39;: &#39;Unsure if the beef is good for hip-hop.&#39;, &#39;sources&#39;: &#39;Eh&#39;}}], &#39;sad_moments&#39;: [{&#39;quote&#39;: &quot;Honestly, I think it&#39;ll stay a hot topic for the fans, but unless someone drops a straight-up diss track, it&#39;s not gonna escalate.&quot;, &#39;description&#39;: &quot;The beef may just stay a topic of discussion among fans, but likely won&#39;t escalate unless they release direct diss tracks.&quot;, &#39;expressed_preference&#39;: {&#39;content&#39;: &quot;The beef will likely remain a topic of discussion but won&#39;t escalate unless they release diss tracks.&quot;, &#39;sources&#39;: &quot;Honestly, I think it&#39;ll stay a hot topic for the fans, but unless someone drops a straight-up diss track, it&#39;s not gonna escalate.&quot;}}], &#39;background_info&#39;: [{&#39;factoid&#39;: {&#39;content&#39;: &quot;Kendrick&#39;s &#39;Control&#39; verse kicked off the beef.&quot;, &#39;sources&#39;: &quot;Definitely was Kendrick&#39;s &#39;Control&#39; verse that kicked it off.&quot;}, &#39;professions&#39;: [], &#39;why&#39;: &#39;This was the event that started the back-and-forth between Drake and Kendrick.&#39;}, {&#39;factoid&#39;: {&#39;content&#39;: &#39;Drake never went directly after Kendrick, just some subtle jabs.&#39;, &#39;sources&#39;: &#39;Drake never went after him directly. Just some subtle jabs here and there.&#39;}, &#39;professions&#39;: [], &#39;why&#39;: &quot;Describes the nature of Drake&#39;s response to Kendrick&#39;s &#39;Control&#39; verse.&quot;}], &#39;moments_summary&#39;: &quot;The conversation covers the ongoing beef between Drake and Kendrick Lamar, including how it started with Kendrick&#39;s &#39;Control&#39; verse, the subtle jabs back and forth, and debate over whether the beef is ultimately good for hip-hop. There are differing views on whether it will escalate beyond just being a topic of discussion among fans.&quot;}]}, &#39;name&#39;: &#39;TranscriptSummary&#39;, &#39;type&#39;: &#39;tool_use&#39;}]</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="go">Tool Calls:</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="go">  TranscriptSummary (toolu_017FF4ZMezU4sv87aa8cLjRT)</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="go"> Call ID: toolu_017FF4ZMezU4sv87aa8cLjRT</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="go">  Args:</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="go">    key_moments: [{&#39;topic&#39;: &#39;Drake and Kendrick Lamar beef&#39;, &#39;happy_moments&#39;: [{&#39;quote&#39;: &quot;It&#39;s wild how this beef is shaping fans.&quot;, &#39;description&#39;: &#39;The beef is generating a lot of interest and debate among fans.&#39;, &#39;expressed_preference&#39;: {&#39;content&#39;: &#39;The beef can push the genre forward and make artists level up.&#39;, &#39;sources&#39;: &quot;When it&#39;s done right, a beef can push the genre forward and make artists level up.&quot;}}, {&#39;quote&#39;: &#39;I just want both of them to keep dropping heat, beef or no beef.&#39;, &#39;description&#39;: &#39;The key is for Drake and Kendrick to keep making great music regardless of their beef.&#39;, &#39;expressed_preference&#39;: {&#39;content&#39;: &#39;Wants Drake and Kendrick to keep making great music, beef or no beef.&#39;, &#39;sources&#39;: &#39;I just want both of them to keep dropping heat, beef or no beef.&#39;}}], &#39;tense_moments&#39;: [{&#39;quote&#39;: &#39;Eh&#39;, &#39;description&#39;: &#39;Unclear if the beef is good for hip-hop.&#39;, &#39;expressed_preference&#39;: {&#39;content&#39;: &#39;Unsure if the beef is good for hip-hop.&#39;, &#39;sources&#39;: &#39;Eh&#39;}}], &#39;sad_moments&#39;: [{&#39;quote&#39;: &quot;Honestly, I think it&#39;ll stay a hot topic for the fans, but unless someone drops a straight-up diss track, it&#39;s not gonna escalate.&quot;, &#39;description&#39;: &quot;The beef may just stay a topic of discussion among fans, but likely won&#39;t escalate unless they release direct diss tracks.&quot;, &#39;expressed_preference&#39;: {&#39;content&#39;: &quot;The beef will likely remain a topic of discussion but won&#39;t escalate unless they release diss tracks.&quot;, &#39;sources&#39;: &quot;Honestly, I think it&#39;ll stay a hot topic for the fans, but unless someone drops a straight-up diss track, it&#39;s not gonna escalate.&quot;}}], &#39;background_info&#39;: [{&#39;factoid&#39;: {&#39;content&#39;: &quot;Kendrick&#39;s &#39;Control&#39; verse kicked off the beef.&quot;, &#39;sources&#39;: &quot;Definitely was Kendrick&#39;s &#39;Control&#39; verse that kicked it off.&quot;}, &#39;professions&#39;: [], &#39;why&#39;: &#39;This was the event that started the back-and-forth between Drake and Kendrick.&#39;}, {&#39;factoid&#39;: {&#39;content&#39;: &#39;Drake never went directly after Kendrick, just some subtle jabs.&#39;, &#39;sources&#39;: &#39;Drake never went after him directly. Just some subtle jabs here and there.&#39;}, &#39;professions&#39;: [], &#39;why&#39;: &quot;Describes the nature of Drake&#39;s response to Kendrick&#39;s &#39;Control&#39; verse.&quot;}], &#39;moments_summary&#39;: &quot;The conversation covers the ongoing beef between Drake and Kendrick Lamar, including how it started with Kendrick&#39;s &#39;Control&#39; verse, the subtle jabs back and forth, and debate over whether the beef is ultimately good for hip-hop. There are differing views on whether it will escalate beyond just being a topic of discussion among fans.&quot;}]</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="go">    metadata: {&#39;title&#39;: &#39;Drake and Kendrick Beef&#39;, &#39;location&#39;: {&#39;sources&#39;: &#39;Conversation transcript&#39;, &#39;content&#39;: &#39;Teleconference&#39;}, &#39;duration&#39;: &#39;25 minutes&#39;}</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="go">    participants: [{&#39;name&#39;: {&#39;sources&#39;: &#39;Conversation transcript&#39;, &#39;content&#39;: &#39;Pete&#39;}, &#39;background_details&#39;: []}, {&#39;name&#39;: {&#39;sources&#39;: &#39;Conversation transcript&#39;, &#39;content&#39;: &#39;Xu&#39;}, &#39;background_details&#39;: []}, {&#39;name&#39;: {&#39;sources&#39;: &#39;Conversation transcript&#39;, &#39;content&#39;: &#39;Laura&#39;}, &#39;background_details&#39;: []}]</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="go">    insightful_quotes: []</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="go">    overall_summary: </span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="go">    next_steps: []</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="go">    other_stuff: []</span>
</span></code></pre></div></p>
<h4 id="and-it-works">And it works!<a class="headerlink" href="#and-it-works" title="Permanent link">&para;</a></h4>
<p>Retries are an easy way to reduce function calling failures. While retrying may become unnecessary with more powerful LLMs, data validation is important to control how LLMs interact with the rest of your software stack.</p>
<p>If you notice high retry rates (using an observability tool like LangSmith), you can set up a rule to send the failure cases to a dataset alongside the corrected values and then automatically program those into your prompts or schemas (or use them as few-shots to have semantically relevant demonstrations).</p>









  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Please help us improve this page by adding to the discussion below.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


  <h2 id="__comments">Comments</h2>
  <script src="https://giscus.app/client.js"
        data-repo="langchain-ai/langgraph"
        data-repo-id="R_kgDOKFU0lQ"
        data-category="Discussions"
        data-category-id="DIC_kwDOKFU0lc4CfZgA"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

                

              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../usaco/usaco/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Competitive Programming">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Competitive Programming
              </div>
            </div>
          </a>
        
        
          
          <a href="../../auth/getting_started/" class="md-footer__link md-footer__link--next" aria-label="Next: Setting up Custom Authentication (Part &amp;#8531;)">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Setting up Custom Authentication (Part &#8531;)
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 LangChain, Inc | <a href="#__consent">Consent Preferences</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs Insiders
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://langchain-ai.github.io/langgraphjs/" target="_blank" rel="noopener" title="langchain-ai.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 32v448h448V32zm243.8 349.4c0 43.6-25.6 63.5-62.9 63.5-33.7 0-53.2-17.4-63.2-38.5l34.3-20.7c6.6 11.7 12.6 21.6 27.1 21.6 13.8 0 22.6-5.4 22.6-26.5V237.7h42.1zm99.6 63.5c-39.1 0-64.4-18.6-76.7-43l34.3-19.8c9 14.7 20.8 25.6 41.5 25.6 17.4 0 28.6-8.7 28.6-20.8 0-14.4-11.4-19.5-30.7-28l-10.5-4.5c-30.4-12.9-50.5-29.2-50.5-63.5 0-31.6 24.1-55.6 61.6-55.6 26.8 0 46 9.3 59.8 33.7L368 290c-7.2-12.9-15-18-27.1-18-12.3 0-20.1 7.8-20.1 18 0 12.6 7.8 17.7 25.9 25.6l10.5 4.5c35.8 15.3 55.9 31 55.9 66.2 0 37.8-29.8 58.6-69.7 58.6"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/langchain-ai/langgraph" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/LangChainAI" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  


  
    
  




  

<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. <strong>Clicking "Accept" makes our documentation better. Thank you!</strong> ❤️</p>
<input class="md-toggle" type="checkbox" id="__settings" checked>
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
      <button type="reset" class="md-button md-button--primary">Reject</button>
    
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.action.edit", "content.tooltips", "header.autohide", "navigation.indexes", "navigation.expand", "navigation.footer", "navigation.instant", "navigation.sections", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.c7c1ca2c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.203fd0bc.min.js"></script>
      
    
  </body>
</html>